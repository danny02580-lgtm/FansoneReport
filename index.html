<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Fansone Report</title>
<script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
<style>
  :root{
    --bg0:#0b1220; --bg1:#0f1a2e; --panel:rgba(255,255,255,.06); --stroke:rgba(255,255,255,.14);
    --text:#e5e7eb; --muted:#9ca3af;
    --new:#3498db; --old:#2980b9;
    --rev:#e74c3c; --single:#a78bfa; --totalrev:#f59e0b;
    --arpu:#d35400;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
    color:var(--text);
    background:
      radial-gradient(1200px 600px at 20% 10%, rgba(52,152,219,.18), transparent 60%),
      radial-gradient(900px 500px at 85% 25%, rgba(231,76,60,.16), transparent 60%),
      radial-gradient(800px 500px at 60% 90%, rgba(245,158,11,.14), transparent 60%),
      linear-gradient(180deg, var(--bg0), var(--bg1));
    min-height:100vh;
  }
  a{color:inherit; text-decoration:none}
  .wrap{max-width:1200px; margin:0 auto; padding:20px 16px 36px}
  .topbar{
    display:flex; align-items:flex-start; justify-content:space-between; gap:14px;
    padding:14px; border:1px solid var(--stroke); border-radius:16px; background:var(--panel); backdrop-filter: blur(10px);
  }
  .title h1{margin:0; font-size:18px}
  .title .sub{margin-top:6px; font-size:12px; color:var(--muted); line-height:1.4}
  #status.ok{color:#34d399}
  #status.err{color:#fb7185}
  .kpis{display:flex; flex-wrap:wrap; gap:10px; justify-content:flex-end; align-items:stretch}
  .kpi{
    padding:12px 14px; border:1px solid var(--stroke); border-radius:16px; background:rgba(255,255,255,.04);
    min-width:220px; display:flex; flex-direction:column; gap:6px;
  }
  .kpi .klabel{font-size:12px; color:var(--muted)}
  .kpi .kvalue{font-size:24px; font-weight:850; letter-spacing:.2px; color:var(--text)}
  .kpi.small{min-width:140px}
  .kpi.small .kvalue{font-size:24px}

  .grid{display:grid; grid-template-columns: 360px 1fr; gap:14px; margin-top:14px}
  @media (max-width: 980px){ .grid{grid-template-columns: 1fr} }
  .panel{border:1px solid var(--stroke); border-radius:16px; background:var(--panel); backdrop-filter: blur(10px); overflow:hidden}
  .hd{padding:12px; border-bottom:1px solid rgba(255,255,255,.10); display:flex; align-items:center; justify-content:space-between; gap:10px}
  .hd h2{margin:0; font-size:13px}
  .bd{padding:12px}

  .select{
    width:100%;
    padding:12px 12px;
    border:1px solid var(--stroke);
    border-radius:14px;
    background:rgba(255,255,255,.04);
    color:var(--text);
    font-size:13px;
    outline:none;
  }
  .hint{margin-top:8px; font-size:11px; color:var(--muted); line-height:1.45}

  .checks{display:grid; grid-template-columns: 1fr; gap:8px; margin-top:10px}
  .check{
    display:flex; gap:10px; align-items:center;
    padding:10px 10px;
    border:1px solid var(--stroke);
    border-radius:14px;
    background:rgba(255,255,255,.03);
  }
  .check input{width:18px; height:18px; accent-color: var(--new)}
  .dot{width:10px; height:10px; border-radius:999px; background:#fff; box-shadow:0 0 0 3px rgba(255,255,255,.07)}
  .label{display:flex; flex-direction:column; gap:2px}
  .label b{font-size:12px; font-weight:750}
  .label span{font-size:11px; color:var(--muted)}

  #chart{width:100%; height:560px}
  @media (max-width: 980px){ #chart{height:520px} }

  .tablesGrid{display:grid; grid-template-columns: 1.3fr 1fr; gap:14px; margin-top:14px}
  @media (max-width: 980px){ .tablesGrid{grid-template-columns: 1fr} }
  table{width:100%; border-collapse:separate; border-spacing:0; font-size:12px}
  th,td{padding:10px 10px; border-bottom:1px solid rgba(255,255,255,.08)}
  th{text-align:left; color:var(--muted); font-weight:700; background:rgba(255,255,255,.03); position:sticky; top:0; backdrop-filter: blur(10px)}
  td.right, th.right{text-align:right}
  tr:hover td{background:rgba(255,255,255,.03)}
  .sheetlink{color: var(--muted); border:1px solid var(--stroke); padding:7px 9px; border-radius:999px; background:rgba(255,255,255,.04)}
  .sheetlink:hover{color:var(--text)}
  .pill{padding:5px 8px; border:1px solid var(--stroke); border-radius:999px; font-size:11px; color:var(--muted); background:rgba(255,255,255,.03)}

/* --- Mobile polish (no layout break) --- */
@media (max-width: 860px){
  .wrap{padding:12px;}
  .hd{flex-direction:column; align-items:flex-start; gap:10px;}
  .kpis{grid-template-columns:1fr 1fr; gap:10px;}
  .kpi .big{font-size:22px;}
  .kpi .sub{font-size:12px;}
  .content{grid-template-columns:1fr; gap:12px;}
  #chart{height:360px !important;}
  .panel{border-radius:14px;}
  .controls{position:sticky; top:0; z-index:5;}
  .checks{max-height:none;}
  table{font-size:12px;}
  .tableWrap{overflow:auto; -webkit-overflow-scrolling:touch;}
}
@media (max-width: 480px){
  .kpis{grid-template-columns:1fr; }
  #chart{height:320px !important;}
  .btn, select, input[type="checkbox"]{touch-action:manipulation;}
}


/* === KPI premium cards (A) === */
.kpis{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px;margin:12px 0 14px;}
.kpi{background:linear-gradient(135deg,rgba(255,255,255,.08),rgba(255,255,255,.03));border:1px solid rgba(255,255,255,.14);
     border-radius:16px;padding:14px 14px;box-shadow:0 14px 34px rgba(0,0,0,.22);}
.kpi .klabel{font-size:12px;color:rgba(255,255,255,.70);letter-spacing:.12em;}
.kpi .kvalue{margin-top:6px;font-size:32px;font-weight:850;letter-spacing:.02em;}
@media(max-width:520px){.kpis{grid-template-columns:1fr;}.kpi .kvalue{font-size:28px;}}


/* === Segmented control (B) === */
.segmented{display:flex;gap:6px;padding:6px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.14);border-radius:14px;
           overflow-x:auto;-webkit-overflow-scrolling:touch;margin:10px 0 10px;}
.segmented::-webkit-scrollbar{height:0}
.seg-btn{flex:1 0 auto;padding:10px 12px;border-radius:12px;border:0;background:transparent;color:rgba(255,255,255,.72);font-weight:750;cursor:pointer;white-space:nowrap;}
.seg-btn.active{background:rgba(255,255,255,.12);color:rgba(255,255,255,.96);}
.select.hidden{display:none!important;}


/* --- Requested UX patches (v3_8 based) --- */
#orderTag{display:none !important;}
.twoline{display:inline-block; line-height:1.05; text-align:center;}
@media (max-width:720px){
  .twoline{font-size:12px;}
}
.kprev{margin-top:6px; font-size:12px; opacity:.85;}


/* Map user insights buttons to segmented style without triggering chart view handlers */
.userseg .userseg-btn{ all:unset; cursor:pointer; padding:10px 12px; border-radius:999px; font-weight:600; letter-spacing:.2px; }
.userseg .userseg-btn.active{ background:rgba(255,255,255,.12); box-shadow:inset 0 0 0 1px rgba(255,255,255,.14); }


/* Hide legacy Prev label */
#prevTotalRevenue{display:none !important;}


/* Match Latest KPI typography to Total Revenue */
.kpi-card[data-kpi="latest"] .kpi-title,
#kpiLatest .kpi-title, #latestKpi .kpi-title, #kpiLatestTitle, #latestKpiTitle{
  font-size: inherit;
}
.kpi-card[data-kpi="latest"] .kpi-value,
#kpiLatest .kpi-value, #latestKpi .kpi-value, #kpiLatestValue, #latestKpiValue{
  font-size: inherit;
  font-weight: inherit;
}


/* Monthly table header: single line + alignment */
#monthlyTable thead th{white-space:nowrap !important; vertical-align:middle !important;}
#monthlyTable thead th:first-child, #monthlyTable tbody td:first-child{white-space:nowrap !important; text-align:left !important;}
#monthlyTable thead th.right, #monthlyTable tbody td.right{text-align:right !important;}

</style>

<style id="customHoverStyle">
/* Hide Plotly default hover label box (keep events) */
.js-plotly-plot .hoverlayer{ opacity:0 !important; pointer-events:none !important; }

/* Custom tooltip card */
#customTooltip{
  position:fixed;
  z-index:9999;
  pointer-events:none;
  min-width: 220px;
  max-width: 340px;
  padding: 12px 14px;
  border-radius: 16px;
  background: rgba(18, 22, 32, 0.78);
  border: 1px solid rgba(255,255,255,0.10);
  box-shadow: 0 16px 48px rgba(0,0,0,0.50);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  color: #fff;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans", "PingFang TC", "Microsoft JhengHei", sans-serif;
}
#customTooltip .tt-title{
  font-weight: 850;
  letter-spacing: .3px;
  margin-bottom: 8px;
  opacity: .95;
}
#customTooltip .tt-row{
  display:flex;
  align-items:center;
  gap:10px;
  margin: 7px 0;
}
#customTooltip .tt-dot{
  width:10px;height:10px;border-radius:999px;flex:0 0 10px;
  box-shadow: 0 0 0 2px rgba(255,255,255,0.10);
}
#customTooltip .tt-name{
  flex:1;
  opacity:.92;
  font-weight:650;
}
#customTooltip .tt-val{
  font-weight:850;
  letter-spacing:.2px;
}
</style>


<style id="customTooltipCardStyles">
.js-plotly-plot .hoverlayer .hovertext{display:none!important;}
#customTooltipCard{
  position:fixed; z-index:99999; display:none; pointer-events:none;
  padding:14px 16px; border-radius:18px;
  background:rgba(12,16,24,.68);
  border:1px solid rgba(255,255,255,.14);
  box-shadow:0 18px 60px rgba(0,0,0,.45);
  backdrop-filter:blur(12px); -webkit-backdrop-filter:blur(12px);
  color:#eef3ff; max-width:min(320px, calc(100vw - 24px));
}
#customTooltipCard .tt-title{font-weight:800;font-size:14px;opacity:.9;margin-bottom:6px;letter-spacing:.2px}
#customTooltipCard .tt-row{display:flex;align-items:center;gap:10px}
#customTooltipCard .dot{width:10px;height:10px;border-radius:999px;flex:0 0 10px;box-shadow:0 0 0 3px rgba(255,255,255,.08)}
#customTooltipCard .name{font-size:13px;font-weight:650;opacity:.92;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
#customTooltipCard .value{margin-left:auto;font-size:16px;font-weight:850;white-space:nowrap}
</style>

</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div class="title">
      <h1>Fansone Report</h1>
      <div class="sub" id="status">Loading…</div>
    </div>
    <div class="kpis">
      <div class="kpi small">
        <div class="klabel">Latest</div>
        <div class="kvalue" id="months">–</div>
      </div>
      <div class="kpi">
        <div class="klabel">Total revenue</div>
        <div class="kvalue" id="totalRevenue">–</div></div>
    </div>
  </div>

  <div class="grid">
    <div class="panel">
      <div class="hd"><h2>圖表切換</h2><span class="pill" id="orderTag">新 → 舊</span></div>
      <div class="bd">
        
<div class="segmented" role="tablist" aria-label="Chart views">
  <button class="seg-btn active" type="button" data-value="money">Revenue</button>
  <button class="seg-btn" type="button" data-value="subs">Subscribers</button>
  <button class="seg-btn" type="button" data-value="mix">Plans</button>
  <button class="seg-btn" type="button" data-value="arpu">ARPU</button>
</div>

<select id="viewSelect" class="select hidden">
          <option value="money">金額（總/訂閱/單片）</option>
          <option value="subs">訂閱人數（新/舊柱狀）</option>
          <option value="mix">方案比例（1/3/6M 勾選）</option>
          <option value="arpu">ARPU（折線）</option>
        </select>
<div class="checks" id="checks"></div>
      </div>
    </div>

    <div class="panel" style="padding:10px">
      <div id="chart"></div>
    </div>
  </div>

  <div class="tablesGrid">
    <div class="panel">
      <div class="hd">
        <div style="display:flex; align-items:center; gap:10px;">
          <h2 style="margin:0;">月度總表</h2><span class="pill">訂閱 + 單片合計</span>
        </div>
      </div>
      <div class="bd" style="padding:0 0 10px 0;">
        <div style="max-height:340px; overflow:auto;">
          <table id="monthlyTable">
            <thead>
              <tr>
                <th>月份</th>
                <th class="right">訂閱人數</th>
                <th class="right">新客</th>
                <th class="right">舊客</th>
                <th class="right">訂閱營收</th>
                <th class="right">單片營收</th>
                <th class="right">總營收</th>
                <th class="right">ARPU</th>
              </tr>
            </thead>
            <tbody id="tbodyMonthly"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="panel">
      <div class="hd">
        <div style="display:flex; align-items:center; gap:10px;">
          <h2 style="margin:0;">用戶分析</h2><span class="pill">Top 10</span>
        </div>
        <div class="segmented userseg" role="tablist" aria-label="User insights metric">
  <button class="userseg-btn active" type="button" data-metric="spend_total">付最多錢</button>
  <button class="userseg-btn" type="button" data-metric="active_months">訂閱最久</button>
</div>
<select id="userMetric" style="display:none" class="select" style="max-width:220px; padding:8px 10px;">
<option value="spend_total">付最多錢（總）</option>
<option value="active_months">訂閱最久（活躍月數）</option>

          
          
          
          
          
          
        </select>
      </div>
      <div class="bd" style="padding:0 0 10px 0;">
        <div style="max-height:340px; overflow:auto;">
          <table>
            <thead>
              <tr>
                <th>User ID</th>
                <th class="right">指標</th>
                <th class="right">訂閱$</th>
                <th class="right">單片$</th>
                <th class="right">總$</th>
              </tr>
            </thead>
            <tbody id="tbodyUsers"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div class="tablesGrid" style="grid-template-columns: 1fr; margin-top:14px;">
    <div class="panel">
      <div class="hd">
        <div style="display:flex; align-items:center; gap:10px;">
          <h2 style="margin:0;">單片 TOP10</h2><span class="pill">點標題可直達貼文</span>
        </div>
</div>
      <div class="bd" style="padding:0 0 10px 0;">
        <div style="max-height:320px; overflow:auto;">
          <table>
            <thead>
              <tr>
                <th>影片標題</th>
                <th class="right">金額</th>
                <th class="right">筆數</th>
              </tr>
            </thead>
            <tbody id="tbodySingles"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script>

const SUB_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQiAPNDCD7qn6atO4VB6Ei63AacDK00AMKM16hK8c-wVWFadPPOj-P8olYQ-ofMFwy0maGU1A4CBneW/pub?gid=0&single=true&output=csv";
const SINGLE_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQiAPNDCD7qn6atO4VB6Ei63AacDK00AMKM16hK8c-wVWFadPPOj-P8olYQ-ofMFwy0maGU1A4CBneW/pub?gid=1226262547&single=true&output=csv";

function el(id){ return document.getElementById(id); }
function money(n){ if(!isFinite(n)) return "–"; return "$ " + Number(n).toLocaleString("en-US"); }
function parseMoney(s){
  if(s==null) return NaN;
  const t = String(s);
  const m = t.match(/-?\d+(?:,\d{3})*(?:\.\d+)?/);
  if(!m) return NaN;
  return Number(m[0].replace(/,/g,""));
}
function toMonthKey(v){
  if(!v) return null;
  const s = String(v).trim();
  const m = s.match(/(\d{4})-(\d{2})/);
  if(!m) return null;
  return m[1] + "-" + m[2];
}
async function fetchCSV(url){
  const r = await fetch(url, {cache:"no-store"});
  if(!r.ok) throw new Error("Fetch failed: " + r.status);
  return await r.text();
}
function splitCSVLine(line){
  const out=[]; let cur=""; let inQ=false;
  for(let i=0;i<line.length;i++) {
    const c=line[i];
    if(c==='"') {
      if(inQ && line[i+1]==='"') { cur+='"'; i++; }
      else inQ=!inQ;
    } else if(c===',' && !inQ) { out.push(cur); cur=""; }
    else cur+=c;
  }
  out.push(cur);
  return out;
}
function csvToRows(csv){
  const text = csv.replace(/^\uFEFF/, "");
  const lines = text.replace(/\r/g,"").trim().split("\n");
  if(lines.length<=1) return [];
  const headers = splitCSVLine(lines[0]).map(h=>h.trim());
  const rows=[];
  for(let i=1;i<lines.length;i++) {
    if(!lines[i].trim()) continue;
    const cols = splitCSVLine(lines[i]);
    const obj={};
    headers.forEach((h,idx)=> obj[h] = (cols[idx] ?? "").trim());
    rows.push(obj);
  }
  return rows;
}
function normalizePlan(plan){
  const s = String(plan||"").toLowerCase();
  if(s.includes("6") || s.includes("半年") || s.includes("6個月")) return "6M";
  if(s.includes("3") || s.includes("三") || s.includes("3個月")) return "3M";
  return "1M";
}
function pickKey(headers, candidates){
  const lower = headers.map(h=>h.toLowerCase());
  for(const cand of candidates){
    const c = String(cand).toLowerCase();
    const idx = lower.findIndex(h => h.includes(c));
    if(idx>=0) return headers[idx];
  }
  return null;
}
function parseTimeToSortable(s){
  // Accept: 2025-11-3001:09:28 or 2025-11-30 01:09:28
  const t = String(s||"").trim();
  const m = t.match(/^(\d{4})-(\d{2})-(\d{2})\s?(\d{2}):(\d{2})(?::(\d{2}))?/);
  if(!m){
    // try to insert space between date and time if missing
    const m2 = t.match(/^(\d{4})-(\d{2})-(\d{2})(\d{2}):(\d{2})(?::(\d{2}))?/);
    if(!m2) return null;
    return `${m2[1]}-${m2[2]}-${m2[3]} ${m2[4]}:${m2[5]}:${m2[6]||"00"}`;
  }
  return `${m[1]}-${m[2]}-${m[3]} ${m[4]}:${m[5]}:${m[6]||"00"}`;
}

let STATE = { aggAsc:[], aggDesc:[], topSingles:[], users:[] };

function buildAgg(subRows, singleRows){
  const subHeaders = Object.keys(subRows[0]||{});
  const timeKey  = pickKey(subHeaders, ["時間","time","date","datetime"]) || subHeaders[0];
  const planKey  = pickKey(subHeaders, ["方案","plan","類型"]) || subHeaders[1];
  const idKey    = pickKey(subHeaders, ["用戶id","user id","userid","id","用戶","user"]) || subHeaders[2];
  const priceKey = pickKey(subHeaders, ["價格","price","金額","amount","收入"]) || subHeaders[Math.min(3, subHeaders.length-1)];

  const monthMap = new Map();
  const seenBefore = new Set();

  const parsedSub = subRows.map(r=>({
    month: toMonthKey(r[timeKey]),
    time: parseTimeToSortable(r[timeKey]) || String(r[timeKey]||""),
    id: String(r[idKey]||"").trim(),
    plan: normalizePlan(r[planKey]),
    price: parseMoney(r[priceKey]),
  })).filter(x=>x.month && x.id);

  parsedSub.sort((a,b)=> (a.month<b.month?-1:a.month>b.month?1: (a.time<b.time?-1:a.time>b.time?1:0)));

  // user agg
  const userMap = new Map();
  function ensureUser(id){
    if(!userMap.has(id)) userMap.set(id, {
      id, subSpend:0, singleSpend:0, totalSpend:0,
      subOrders:0, singleOrders:0, totalOrders:0,
      firstTs:null, lastTs:null, activeMonths:new Set()
    });
    return userMap.get(id);
  }
  function updateTime(u, ts){
    if(!ts) return;
    if(!u.firstTs || ts < u.firstTs) u.firstTs = ts;
    if(!u.lastTs  || ts > u.lastTs)  u.lastTs  = ts;
  }

  for(const rec of parsedSub){
    if(!monthMap.has(rec.month)) monthMap.set(rec.month, {
      month: rec.month,
      subIds: new Set(),
      newIds: new Set(),
      oldIds: new Set(),
      planCount: {"1M":0,"3M":0,"6M":0},
      subRevenue: 0,
      singleRevenue: 0,
    });
    const m = monthMap.get(rec.month);

    if(!m.subIds.has(rec.id)){
      m.subIds.add(rec.id);
      if(seenBefore.has(rec.id)) m.oldIds.add(rec.id); else m.newIds.add(rec.id);
    }
    m.planCount[rec.plan] = (m.planCount[rec.plan]||0) + 1;
    if(isFinite(rec.price)) m.subRevenue += rec.price;
    seenBefore.add(rec.id);

    const u = ensureUser(rec.id);
    if(isFinite(rec.price)) { u.subSpend += rec.price; u.totalSpend += rec.price; }
    u.subOrders += 1; u.totalOrders += 1;
    u.activeMonths.add(rec.month);
    updateTime(u, rec.time);
  }

  const sHeaders = Object.keys(singleRows[0]||{});
  const sTimeKey  = pickKey(sHeaders, ["時間","time","date","datetime"]) || sHeaders[0];
  const sTitleKey = pickKey(sHeaders, ["影片標題","標題","title","影片","內容"]) || sHeaders[1];
  const sUrlKey   = pickKey(sHeaders, ["網址","url","link"]) || sHeaders[2];
  const sIdKey    = pickKey(sHeaders, ["用戶id","user id","userid","id","用戶","user"]) || sHeaders[3];
  const sPriceKey = pickKey(sHeaders, ["價格","price","金額","amount","收入"]) || sHeaders[Math.min(4, sHeaders.length-1)];

  const titleAgg = new Map();
  for(const r of singleRows){
    const title = String(r[sTitleKey]||"").trim();
    const url = String(r[sUrlKey]||"").trim();
    const price = parseMoney(r[sPriceKey]);
    const uid = String(r[sIdKey]||"").trim();
    if(title){
      if(!titleAgg.has(title)) titleAgg.set(title, {title, url, sum:0, count:0});
      const t = titleAgg.get(title);
      if(!t.url && url) t.url=url;
      if(isFinite(price)) t.sum += price;
      t.count += 1;
    }
    if(uid){
      const u = ensureUser(uid);
      if(isFinite(price)) { u.singleSpend += price; u.totalSpend += price; }
      u.singleOrders += 1; u.totalOrders += 1;
      const ts = parseTimeToSortable(r[sTimeKey]) || String(r[sTimeKey]||"");
      updateTime(u, ts);
      const mo = toMonthKey(r[sTimeKey]);
      if(mo) u.activeMonths.add(mo);
    }
  }

  for(const r of singleRows){
    const month = toMonthKey(r[sTimeKey]);
    if(!month) continue;
    const price = parseMoney(r[sPriceKey]);
    if(!monthMap.has(month)) monthMap.set(month, {
      month, subIds:new Set(), newIds:new Set(), oldIds:new Set(),
      planCount: {"1M":0,"3M":0,"6M":0}, subRevenue:0, singleRevenue:0
    });
    const m = monthMap.get(month);
    if(isFinite(price)) m.singleRevenue += price;
  }

  const monthsAsc = Array.from(monthMap.keys()).sort();
  const aggAsc = monthsAsc.map(k=>{
    const m = monthMap.get(k);
    const subs = m.subIds.size;
    const newUsers = m.newIds.size;
    const oldUsers = m.oldIds.size;
    const orders = (m.planCount["1M"] + m.planCount["3M"] + m.planCount["6M"]) || 0;
    const p1 = orders? m.planCount["1M"]/orders : 0;
    const p3 = orders? m.planCount["3M"]/orders : 0;
    const p6 = orders? m.planCount["6M"]/orders : 0;
    const subRevenue = m.subRevenue || 0;
    const singleRevenue = m.singleRevenue || 0;
    const totalRevenue = subRevenue + singleRevenue;
    const arpu = subs? subRevenue/subs : NaN;
    return { month:k, subs, newUsers, oldUsers, p1, p3, p6, subRevenue, singleRevenue, totalRevenue, arpu };
  });

  const topSingles = Array.from(titleAgg.values()).sort((a,b)=>b.sum-a.sum).slice(0,10);

  const users = Array.from(userMap.values()).map(u=>{
    const monthsActive = u.activeMonths.size;
    let spanDays = null;
    if(u.firstTs && u.lastTs){
      const a = Date.parse(u.firstTs.replace(" ", "T") + "+08:00");
      const b = Date.parse(u.lastTs.replace(" ", "T") + "+08:00");
      if(isFinite(a) && isFinite(b)) spanDays = Math.round((b-a)/(1000*60*60*24));
    }
    return {...u, monthsActive, spanDays};
  });

  return { aggAsc, topSingles, users };
}

function renderTables(aggDesc, topSingles){
  el("tbodyMonthly").innerHTML = aggDesc.map(x=>(
    `<tr>
      <td>${x.month}</td>
      <td class="right">${x.subs}</td>
      <td class="right">${x.newUsers}</td>
      <td class="right">${x.oldUsers}</td>
      <td class="right">${Math.round(x.subRevenue).toLocaleString("en-US")}</td>
      <td class="right">${Math.round(x.singleRevenue).toLocaleString("en-US")}</td>
      <td class="right">${Math.round(x.totalRevenue).toLocaleString("en-US")}</td>
      <td class="right">${isFinite(x.arpu)?x.arpu.toFixed(1):"–"}</td>
    </tr>`
  )).join("");

  el("tbodySingles").innerHTML = topSingles.map(t=>{
    const safeTitle = t.title.replace(/</g,"&lt;").replace(/>/g,"&gt;");
    const link = t.url ? `<a href="${t.url}" target="_blank" rel="noopener">${safeTitle}</a>` : safeTitle;
    return `<tr>
      <td>${link}</td>
      <td class="right">${Math.round(t.sum).toLocaleString("en-US")}</td>
      <td class="right">${t.count}</td>
    </tr>`;
  }).join("");
}

function renderUsers(metric){
  const users = STATE.users || [];
  const rows = [...users];
  let getVal = (u)=>u.totalSpend;
  let fmt = (v)=> Math.round(v).toLocaleString("en-US");
  let label = "總$";
  if(metric==="spend_sub"){ getVal=(u)=>u.subSpend; label="訂閱$"; }
  else if(metric==="spend_single"){ getVal=(u)=>u.singleSpend; label="單片$"; }
  else if(metric==="active_months"){ getVal=(u)=>u.monthsActive; fmt=(v)=>String(v); label="月數"; }
  else if(metric==="tenure_span"){ getVal=(u)=> (u.spanDays==null?-1:u.spanDays); fmt=(v)=> (v<0?"–":(v+"d")); label="跨度"; }
  else if(metric==="orders_total"){ getVal=(u)=>u.totalOrders; fmt=(v)=>String(v); label="次數"; }

  rows.sort((a,b)=> (getVal(b) - getVal(a)));
  const top = rows.filter(u=>getVal(u)>0).slice(0,10);

  el("tbodyUsers").innerHTML = top.map(u=>(
    `<tr>
      <td>${u.id}</td>
      <td class="right">${fmt(getVal(u))}</td>
      <td class="right">${Math.round(u.subSpend).toLocaleString("en-US")}</td>
      <td class="right">${Math.round(u.singleSpend).toLocaleString("en-US")}</td>
      <td class="right">${Math.round(u.totalSpend).toLocaleString("en-US")}</td>
    </tr>`
  )).join("") || `<tr><td colspan="5" style="color:rgba(156,163,175,.9); padding:14px;">（目前沒有資料）</td></tr>`;
}

function makeChecksFor(view){
  const css = getComputedStyle(document.documentElement);
  const itemsByView = {
    money: [
      { id:"r_total",  color:css.getPropertyValue('--totalrev').trim(), title:"總營收", desc:"訂閱 + 單片" },
      { id:"r_sub",    color:css.getPropertyValue('--rev').trim(),      title:"訂閱營收", desc:"訂閱金額" },
      { id:"r_single", color:css.getPropertyValue('--single').trim(),   title:"單片營收", desc:"單片金額" },
    ],
    subs: [
      { id:"s_new", color:css.getPropertyValue('--new').trim(), title:"新客", desc:"柱狀（新客）" },
      { id:"s_old", color:css.getPropertyValue('--old').trim(), title:"舊客", desc:"柱狀（舊客）" },
    ],
    mix: [
      { id:"p_1", color:"#22c55e", title:"1M", desc:"單月" },
      { id:"p_3", color:"#60a5fa", title:"3M", desc:"三月" },
      { id:"p_6", color:"#f97316", title:"6M", desc:"六月" },
    ],
    arpu: [],
  };
  const items = itemsByView[view] || [];
  const box = el("checks");
  box.innerHTML = items.map(it=>(
    `<label class="check">
      <input type="checkbox" id="${it.id}" />
      <span class="dot" style="background:${it.color}"></span>
      <span class="label"><b>${it.title}</b><span>${it.desc}</span></span>
    </label>`
  )).join("");
  box.style.display = (view==="arpu") ? "none" : "grid";
}

function applyOrder(newestFirst){
  const a = STATE.aggAsc;
  STATE.aggDesc = newestFirst ? [...a].reverse() : [...a];
  el("orderTag").textContent = newestFirst ? "新 → 舊" : "舊 → 新";
}

function buildTraces(view){
  const agg = STATE.aggDesc;
  const x = agg.map(d=>Number(d.month.split("-")[1]));
  const xText = agg.map(d=>d.month);

  const newY = agg.map(d=>d.newUsers);
  const oldY = agg.map(d=>d.oldUsers);
  const subRev = agg.map(d=>Math.round(d.subRevenue));
  const singleRev = agg.map(d=>Math.round(d.singleRevenue));
  const totalRev = agg.map(d=>Math.round(d.totalRevenue));
  const arpu = agg.map(d=> (isFinite(d.arpu)? Number(d.arpu.toFixed(1)) : null));
  const p1 = agg.map(d=> (d.p1*100));
  const p3 = agg.map(d=> (d.p3*100));
  const p6 = agg.map(d=> (d.p6*100));

  const css = getComputedStyle(document.documentElement);
  const CNEW = css.getPropertyValue('--new').trim();
  const COLD = css.getPropertyValue('--old').trim();
  const CREV = css.getPropertyValue('--rev').trim();
  const CSIN = css.getPropertyValue('--single').trim();
  const CTOT = css.getPropertyValue('--totalrev').trim();
  const CARPU = css.getPropertyValue('--arpu').trim();

  const xaxis = {
    tickmode:"array",
    tickvals:x,
    ticktext:x.map(v=>String(v)),
    gridcolor:"rgba(255,255,255,.08)",
    zeroline:false,
    tickfont:{color:"rgba(229,231,235,.9)", size:12},
  };
  const yCommon = {
    gridcolor:"rgba(255,255,255,.10)",
    zeroline:false,
    tickfont:{color:"rgba(229,231,235,.9)", size:12},
  };
  const labelFont = {color:"rgba(229,231,235,.95)", size:12};
  const labelFontSmall = {color:"rgba(229,231,235,.95)", size:11};

  if(view==="subs"){
    return {
      traces: [
        {name:"New users", type:"bar", x, y:newY, marker:{color:CNEW},
          text:newY.map(v=>String(v)), textposition:"inside", insidetextanchor:"middle", textfont:labelFontSmall,
          customdata:xText, hovertemplate:"%{customdata}<br>New: <b>%{y}</b><extra></extra>"},
        {name:"Old users", type:"bar", x, y:oldY, marker:{color:COLD},
          text:oldY.map(v=>String(v)), textposition:"inside", insidetextanchor:"middle", textfont:labelFontSmall,
          customdata:xText, hovertemplate:"%{customdata}<br>Old: <b>%{y}</b><extra></extra>"},
      ],
      layout: { barmode:"stack", xaxis, yaxis: yCommon },
      defaults: ["s_new","s_old"],
};
  }
  if(view==="mix"){
    return {
      traces: [
        {name:"1M", type:"bar", x, y:p1, marker:{color:"#22c55e"}, opacity:0.92,
          text:p1.map(v=>v.toFixed(1)+"%"), textposition:"inside", textfont:labelFontSmall,
          customdata:xText, hovertemplate:"%{customdata}<br>1M: <b>%{y:.1f}%</b><extra></extra>"},
        {name:"3M", type:"bar", x, y:p3, marker:{color:"#60a5fa"}, opacity:0.92,
          text:p3.map(v=>v.toFixed(1)+"%"), textposition:"inside", textfont:labelFontSmall,
          customdata:xText, hovertemplate:"%{customdata}<br>3M: <b>%{y:.1f}%</b><extra></extra>"},
        {name:"6M", type:"bar", x, y:p6, marker:{color:"#f97316"}, opacity:0.92,
          text:p6.map(v=>v.toFixed(1)+"%"), textposition:"inside", textfont:labelFontSmall,
          customdata:xText, hovertemplate:"%{customdata}<br>6M: <b>%{y:.1f}%</b><extra></extra>"},
      ],
      layout: { barmode:"stack", xaxis, yaxis: {...yCommon, range:[0,100], ticksuffix:"%"} },
      defaults: ["p_1","p_3","p_6"],
};
  }
  if(view==="arpu"){
    return {
      traces: [
        {name:"ARPU", type:"scatter", mode:"lines+markers+text", x, y:arpu,
          line:{color:CARPU,width:3}, marker:{size:8,color:CARPU},
          text:arpu.map(v=> (v==null? "" : String(v))), textposition:"top center", textfont:labelFont,
          customdata:xText, hovertemplate:"%{customdata}<br>ARPU: <b>%{y}</b><extra></extra>"},
      ],
      layout: { xaxis, yaxis: yCommon },
      defaults: [],
};
  }
  return {
    traces: [
      {name:"Total revenue", type:"scatter", mode:"lines+markers+text", x, y:totalRev,
        line:{color:CTOT,width:3}, marker:{size:8,color:CTOT},
        text:totalRev.map(v=>String(v)), textposition:"top center", textfont:labelFont,
        customdata:xText, hovertemplate:"%{customdata}<br>Total: <b>%{y}</b><extra></extra>"},
      {name:"Sub revenue", type:"scatter", mode:"lines+markers+text", x, y:subRev,
        line:{color:CREV,width:3}, marker:{size:8,color:CREV},
        text:subRev.map(v=>String(v)), textposition:"top center", textfont:labelFont,
        customdata:xText, hovertemplate:"%{customdata}<br>Sub: <b>%{y}</b><extra></extra>"},
      {name:"Single revenue", type:"scatter", mode:"lines+markers+text", x, y:singleRev,
        line:{color:CSIN,width:3,dash:"dot"}, marker:{size:8,color:CSIN},
        text:singleRev.map(v=>String(v)), textposition:"top center", textfont:labelFont,
        customdata:xText, hovertemplate:"%{customdata}<br>Single: <b>%{y}</b><extra></extra>"},
    ],
    layout: { xaxis, yaxis: yCommon },
    defaults: ["r_total","r_sub","r_single"],
};
}

function layoutBase(){
  return {
    dragmode:false,
    paper_bgcolor:"rgba(0,0,0,0)",
    plot_bgcolor:"rgba(255,255,255,0.02)",
    margin:{l:56,r:40,t:22,b:46},
    bargap:0.35,
    legend:{orientation:"h", x:0, y:1.12, font:{color:"rgba(229,231,235,.9)"}},
    hovermode:"x unified",
    hoverlabel:{bgcolor:"rgba(15,23,42,.95)", bordercolor:"rgba(255,255,255,.14)", font:{color:"#e5e7eb"}},
  };
}

function renderChart(view){
  makeChecksFor(view);
  const built = buildTraces(view);
  const layout = {...layoutBase(), ...built.layout};
  const config = {responsive:true, displaylogo:false, displayModeBar:false, scrollZoom:false, doubleClick:false};

  Plotly.react("chart", built.traces, layout, config).then(()=>{
    if(view!=="arpu"){
      (built.defaults||[]).forEach(id=>{ const node=document.getElementById(id); if(node) node.checked=true; });
      applyVisibility(view, built.traces);
      document.querySelectorAll("#checks input[type=checkbox]").forEach(cb=> cb.addEventListener("change", ()=>applyVisibility(view, built.traces)));
    } else {
      Plotly.restyle("chart", "visible", built.traces.map(()=>true));
    }
  });
}

function applyVisibility(view, traces){
  let vis = new Array(traces.length).fill(false);
  const on = (id)=> { const n=document.getElementById(id); return n && n.checked; };

  if(view==="money"){
    if(on("r_total")) vis[0]=true;
    if(on("r_sub")) vis[1]=true;
    if(on("r_single")) vis[2]=true;
  } else if(view==="subs"){
    if(on("s_new")) vis[0]=true;
    if(on("s_old")) vis[1]=true;
  } else if(view==="mix"){
    if(on("p_1")) vis[0]=true;
    if(on("p_3")) vis[1]=true;
    if(on("p_6")) vis[2]=true;
  }
  Plotly.restyle("chart", "visible", vis);
}

async function main(){
  try{
    if(location.protocol==="file:") {
      el("status").className = "sub err"; el("status").textContent = "● Open via URL (Vercel/localhost). file:// blocks CSV requests.";
      return;
    }
    el("status").className = "sub"; el("status").textContent = "Loading… Fetching data";

    const [subCSV, singleCSV] = await Promise.all([fetchCSV(SUB_CSV_URL), fetchCSV(SINGLE_CSV_URL)]);
    const subRows = csvToRows(subCSV);
    const singleRows = csvToRows(singleCSV);

    if(!subRows.length) throw new Error("訂閱CSV 沒抓到資料（可能還沒 publish 或 gid 錯）");
    if(!singleRows.length) throw new Error("單片CSV 沒抓到資料（可能還沒 publish 或 gid 錯）");

    const built = buildAgg(subRows, singleRows);
    STATE.aggAsc = built.aggAsc;
    STATE.topSingles = built.topSingles;
    STATE.users = built.users;

    applyOrder(true);

    el("months").textContent = String(STATE.aggAsc.length);
    el("totalRevenue").textContent = money(Math.round(STATE.aggAsc.reduce((a,b)=>a+(b.totalRevenue||0),0)));

    renderTables(STATE.aggDesc, STATE.topSingles);
    renderUsers(el("userMetric").value);
    el("userMetric").addEventListener("change", (e)=> renderUsers(e.target.value));

    renderChart("money");
    el("viewSelect").addEventListener("change", (e)=> renderChart(e.target.value));

    el("status").className = "sub ok"; el("status").textContent = "● Data loaded • Last updated: " + new Date().toLocaleString();
  } catch(err) {
    el("status").textContent = "❌ Load failed: " + (err && err.message ? err.message : String(err));
  }
}
main();
</script>

<script>

(function(){
  const sel = document.getElementById('viewSelect');
  const buttons = Array.from(document.querySelectorAll('.seg-btn'));
  if(!sel || buttons.length===0) return;

  function setActive(val){
    buttons.forEach(b=>b.classList.toggle('active', b.dataset.value===val));
  }

  // Initialize from default render (script uses renderChart("money"))
  setActive(sel.value || 'money');

  buttons.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const val = btn.dataset.value;
      sel.value = val;
      setActive(val);
      sel.dispatchEvent(new Event('change', {bubbles:true}));
    });
  });
})();
</script>

<script>


(function(){
  // Sync user insights segmented buttons to hidden select
  const userSel = document.getElementById("userMetric");
  const userBtns = document.querySelectorAll(".userseg .userseg-btn");
  if(userSel && userBtns.length){
    userBtns.forEach(btn=>{
      btn.addEventListener("click", ()=>{
        userBtns.forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        const v = btn.getAttribute("data-metric");
        if(v){
          userSel.value = v;
          userSel.dispatchEvent(new Event("change", {bubbles:true}));
        }
      });
    });
  }

  // Prev month total revenue: read from Monthly summary table (tbodyMonthly)
  // (patched) prevent legacy Prev logic from running
  return;

  function moneyFmt(n){
    if(typeof window.money==="function") return window.money(n);
    return "NT$ " + n.toLocaleString("en-US");
  }
  function readPrevFromMonthly(){
    if(!prevEl) return;
    const tbody = document.getElementById("tbodyMonthly");
    const rows = tbody.querySelectorAll("tr");
    const prevRow = rows[rows.length-2];
    const cells = prevRow.querySelectorAll("td");
    const lastCell = cells[cells.length-1]; // total revenue column
    const num = parseInt((lastCell.textContent||"").replace(/[^0-9]/g,""),10);
    if(!isNaN(num) && num>0){
    } else {
    }
  }
  // retry a few times after render
  setTimeout(readPrevFromMonthly, 200);
  setTimeout(readPrevFromMonthly, 600);
  setTimeout(readPrevFromMonthly, 1200);
})();

</script>


<script>

// --- Prev: compute from monthly table header (robust + observer) ---
(function(){
  if(!prevEl) return;

  function moneyFmt(n){
    if(typeof window.money==="function") return window.money(n);
    return "NT$ " + n.toLocaleString("en-US");
  }

  function parseMonthCell(text){
    const t = (text||"").trim();
    let m = t.match(/(\d{4})\D(\d{1,2})/);
    if(m) return {y:parseInt(m[1],10), mo:parseInt(m[2],10)};
    m = t.match(/^\s*(\d{1,2})\s*$/);
    if(m) return {y:null, mo:parseInt(m[1],10)};
    const nums = t.match(/(\d{1,2})/g);
    if(nums && nums.length) return {y:null, mo:parseInt(nums[nums.length-1],10)};
    return null;
  }

  function getTotalIdx(table){
    const ths = Array.from(table.querySelectorAll("thead th")).map(th => (th.textContent||"").trim().toLowerCase());
    // strict: prefer "總營收" / "總收入" first
    let idx = ths.findIndex(t => t.includes("總營收") || t.includes("總收入"));
    if(idx >= 0) return idx;
    // strict english: "total revenue"
    idx = ths.findIndex(t => t.includes("total revenue"));
    if(idx >= 0) return idx;
    // fallback: if there is "subscription revenue" and "single" columns, take the column named "total"
    idx = ths.findIndex(t => t === "total" || t === "totalrevenue" || t === "total revenue");
    return idx;
  }

  function computePrev(){
    const tbody = document.getElementById("tbodyMonthly") || document.querySelector("#monthlyTable tbody");
    const table = tbody ? tbody.closest("table") : null;

    const totalIdx = getTotalIdx(table);

    const rows = Array.from(tbody.querySelectorAll("tr"));
    const parsed = rows.map(r=>{
      const tds = Array.from(r.querySelectorAll("td"));
      if(!tds.length || totalIdx >= tds.length) return null;
      const mi = parseMonthCell(tds[0].textContent);
      const total = parseInt((tds[totalIdx].textContent||"").replace(/[^0-9]/g,""),10);
      if(!mi || isNaN(total)) return null;
      return {y:mi.y, mo:mi.mo, total};
    }).filter(Boolean);


    parsed.sort((a,b)=>{
      const ay = (a.y ?? 0), by = (b.y ?? 0);
      if(ay !== by) return ay - by;
      return a.mo - b.mo;
    });

    const latest = parsed[parsed.length-1];
    let target = null;
    if(latest.y != null){
      const prevMo = latest.mo - 1;
      const prevY = prevMo >= 1 ? latest.y : (latest.y - 1);
      const wantMo = prevMo >= 1 ? prevMo : 12;
      target = parsed.slice().reverse().find(p => p.y === prevY && p.mo === wantMo);
    } else {
      const wantMo = latest.mo - 1;
      target = parsed.slice().reverse().find(p => p.mo === wantMo);
    }
    if(!target) target = parsed[parsed.length-2];

  }

  // run + observe table updates
  computePrev();
  setTimeout(computePrev, 500);
  setTimeout(computePrev, 1500);
  setTimeout(computePrev, 3000);

  const tbody = document.getElementById("tbodyMonthly");
  if(tbody && window.MutationObserver){
    const obs = new MutationObserver(()=>computePrev());
    obs.observe(tbody, {childList:true, subtree:true});
  }
})();
</script>


<script>

(function(){
  function moneyFmt(n){
    if(typeof window.money==="function") return window.money(n);
    return "NT$ " + n.toLocaleString("en-US");
  }
  function parseMonth(s){
    s = (s||"").trim();
    let m = s.match(/(\d{4})\D(\d{1,2})/);
    if(m) return {y:+m[1], mo:+m[2]};
    m = s.match(/^\s*(\d{1,2})\s*$/);
    if(m) return {y:0, mo:+m[1]};
    const nums = s.match(/(\d{1,2})/g);
    if(nums && nums.length) return {y:0, mo:+nums[nums.length-1]};
    return null;
  }
  function findTotalColIndex(){
    // try table header labels
    const table = document.querySelector("#tbodyMonthly")?.closest("table");
    if(!table) return null;
    const ths = Array.from(table.querySelectorAll("thead th"));
    const labels = ths.map(th=>th.textContent.trim().toLowerCase());
    const candidates = ["total","total revenue","總營收","總收入","營收","revenue"];
    for(const c of candidates){
      const idx = labels.findIndex(t=>t.includes(c));
      if(idx>=0) return idx;
    }
    return null;
  }
  function setLatest(){
    const monthsEl = document.getElementById("months");
    const tbody = document.getElementById("tbodyMonthly");
    if(!tbody) return;
    const rows = Array.from(tbody.querySelectorAll("tr"));
    if(!rows.length) return;

    const totalIdx = findTotalColIndex();
    // if can't find, fallback to second last cell
    let best = null;
    for(const r of rows){
      const tds = Array.from(r.querySelectorAll("td"));
      if(!tds.length) continue;
      const mi = parseMonth(tds[0].textContent);
      if(!mi) continue;
      let cell = null;
      if(totalIdx != null && tds[totalIdx]) cell = tds[totalIdx];
      else cell = tds[Math.max(0, tds.length-2)];
      const val = parseInt((cell.textContent||"").replace(/[^0-9]/g,""),10);
      if(isNaN(val)) continue;
      const key = mi.y*100 + mi.mo;
      if(!best || key > best.key) best = {key, val};
    }
    if(!best) return;

    if(monthsEl) monthsEl.textContent = moneyFmt(best.val);
    if(latestEl) latestEl.textContent = "Latest " + moneyFmt(best.val);
  }

  // Run and observe updates
  setLatest();
  setTimeout(setLatest, 400);
  setTimeout(setLatest, 1200);
  setTimeout(setLatest, 2400);

  const tbody = document.getElementById("tbodyMonthly");
  if(tbody && window.MutationObserver){
    const obs = new MutationObserver(()=>setLatest());
    obs.observe(tbody, {childList:true, subtree:true});
  }
})();
</script>


<script>

// Ensure Latest KPI uses same emphasis class as Total Revenue
(function(){
  function syncKpiStyles(){
    const totalCard = document.querySelector('.kpi-card[data-kpi="total"], #kpiTotal, #totalKpi, [data-kpi="totalRevenue"]');
    const latestCard = document.querySelector('.kpi-card[data-kpi="latest"], #kpiLatest, #latestKpi, [data-kpi="latestRevenue"]');
    if(totalCard && latestCard){
      // copy key classes if present
      ["kpi-primary","kpi-big","primary","big"].forEach(cls=>{
        if(totalCard.classList.contains(cls)) latestCard.classList.add(cls);
      });
    }
  }
  setTimeout(syncKpiStyles, 0);
  setTimeout(syncKpiStyles, 300);
})();
</script>

<div id="customTooltip" style="display:none"></div>




<script id="safeHoverEnhancer">
(function(){
  function enhance(gd){
    if(!gd || gd.__safeHoverBound || !gd.on) return;
    gd.__safeHoverBound = true;

    try{
      Plotly.relayout(gd, {hovermode:'closest', hoverdistance:18, spikedistance:-1});
    }catch(e){}

    const orig = {};
    function remember(ti){
      if(orig[ti]) return;
      const tr = gd.data[ti] || {};
      orig[ti] = {
        marker: tr.marker ? JSON.parse(JSON.stringify(tr.marker)) : null,
        mode: tr.mode
      };
    }
    function restore(){
      Object.keys(orig).forEach(k=>{
        const ti = Number(k);
        const o = orig[ti];
        try{ Plotly.restyle(gd, {'marker':[o.marker], 'mode':[o.mode]}, [ti]); }catch(e){}
      });
    }

    gd.on('plotly_hover', function(e){
      try{
        if(!e || !e.points || !e.points.length) return;
        const pt = e.points[0];
        const ti = pt.curveNumber;
        const tr = gd.data[ti] || {};
        remember(ti);

        const n = (tr.x && tr.x.length) || (tr.y && tr.y.length) || 0;
        const idx = pt.pointNumber;
        const base = (tr.marker && tr.marker.size) || 8;
        const baseNum = (typeof base === 'number') ? base : 8;

        const sizeArr = Array(n).fill(baseNum);
        if(idx!=null && idx>=0 && idx<n) sizeArr[idx] = Math.round(baseNum*1.8);

        const marker = Object.assign({}, tr.marker || {});
        marker.size = sizeArr;
        marker.line = Object.assign({}, marker.line || {});
        marker.line.width = Array(n).fill(0).map((_,i)=> i===idx ? 3 : 0);
        marker.line.color = Array(n).fill('rgba(255,255,255,0)').map((_,i)=> i===idx ? 'rgba(255,255,255,0.9)' : 'rgba(255,255,255,0)');

        const mode = (tr.mode || '').includes('markers') ? tr.mode : ((tr.mode ? tr.mode+'+' : '') + 'markers');
        Plotly.restyle(gd, {'marker':[marker], 'mode':[mode]}, [ti]);
      }catch(err){}
    });

    gd.on('plotly_unhover', function(){
      try{ restore(); }catch(e){}
    });
  }

  function scan(){
    document.querySelectorAll('.js-plotly-plot').forEach(enhance);
  }

  const obs = new MutationObserver(()=>scan());
  obs.observe(document.documentElement, {childList:true, subtree:true});
  window.addEventListener('load', ()=>{ setTimeout(scan,200); setTimeout(scan,800); setTimeout(scan,1500); });
})();
</script>


<script id="customTooltipCardScriptV2">
(function(){
  let lastMouse = {x: null, y: null};
  let lock = {key:null, t:0};
  const LOCK_MS = 140;

  function ensureCard(){
    let el=document.getElementById('customTooltipCard');
    if(!el){
      el=document.createElement('div');
      el.id='customTooltipCard';
      el.innerHTML='<div class="tt-title"></div><div class="tt-row"><span class="dot"></span><span class="name"></span><span class="value"></span></div>';
      document.body.appendChild(el);
    }
    return el;
  }
  const card=ensureCard();
  const titleEl=card.querySelector('.tt-title');
  const dotEl=card.querySelector('.dot');
  const nameEl=card.querySelector('.name');
  const valueEl=card.querySelector('.value');

  function colorOf(pt){
    try{
      const tr=pt.fullData||pt.data||{};
      let c=(tr.line&&tr.line.color)||(tr.marker&&tr.marker.color)||'#fff';
      if(Array.isArray(c)) c=c[0]||'#fff';
      return c;
    }catch(e){return '#fff';}
  }
  function kindFor(name){
    const s=(name||'').toLowerCase();
    if(s.includes('revenue')||s.includes('營收')||s.includes('total')||s.includes('arpu')) return 'money';
    if(s.includes('%')||s.includes('rate')||s.includes('ratio')||s.includes('比例')||s.includes('成長')) return 'pct';
    if(s.includes('user')||s.includes('subscriber')||s.includes('客')||s.includes('人數')) return 'int';
    return 'num';
  }
  function fmt(v, kind){
    if(v==null||isNaN(v)) return '-';
    const n=Number(v);
    if(kind==='money') return 'NT$ '+n.toLocaleString(undefined,{maximumFractionDigits:0});
    if(kind==='pct') return n.toFixed(1)+'%';
    if(kind==='int') return n.toLocaleString(undefined,{maximumFractionDigits:0});
    return n.toLocaleString(undefined,{maximumFractionDigits:1});
  }
  function place(x,y){
    const pad=10;
    if(typeof x!=='number'||typeof y!=='number') return;
    card.style.display='block';
    const rect=card.getBoundingClientRect();
    let px=x+14, py=y+14;
    const vw=window.innerWidth, vh=window.innerHeight;
    if(px+rect.width+pad>vw) px=x-rect.width-14;
    if(py+rect.height+pad>vh) py=y-rect.height-14;
    card.style.left=Math.max(8,px)+'px';
    card.style.top =Math.max(8,py)+'px';
  }

  function bind(gd){
    if(!gd||gd.__cardBound||!gd.on) return;
    gd.__cardBound=true;

    // Track mouse position over the graph div
    gd.addEventListener('mousemove', (ev)=>{ lastMouse.x=ev.clientX; lastMouse.y=ev.clientY; }, {passive:true});
    gd.addEventListener('mouseleave', ()=>{ card.style.display='none'; }, {passive:true});

    gd.on('plotly_hover', function(e){
      try{
        if(!e||!e.points||!e.points.length) return;
        const pt=e.points[0];
        const now=Date.now();
        const key=(pt.curveNumber!=null?pt.curveNumber:'')+':' + (pt.pointNumber!=null?pt.pointNumber:'');
        if(lock.key && key!==lock.key && (now-lock.t)<LOCK_MS){ return; }
        lock.key=key; lock.t=now;
        const xlab=pt.x;
        const name=(pt.fullData&&pt.fullData.name)||(pt.data&&pt.data.name)||'Value';
        const yval=pt.y;

        titleEl.textContent=String(xlab);
        dotEl.style.background=colorOf(pt);
        nameEl.textContent=name;
        valueEl.textContent=fmt(yval, kindFor(name));

        // Use provided event coords if available; fallback to lastMouse
        const ev=e.event||pt.event;
        const cx=(ev&&typeof ev.clientX==='number')?ev.clientX:lastMouse.x;
        const cy=(ev&&typeof ev.clientY==='number')?ev.clientY:lastMouse.y;
        place(cx,cy);
      }catch(err){}
    });
    gd.on('plotly_unhover', function(){ card.style.display='none'; lock.key=null; lock.t=0; });

    window.addEventListener('scroll', ()=>{ card.style.display='none'; }, {passive:true});
    window.addEventListener('resize', ()=>{ card.style.display='none'; }, {passive:true});
  }

  function scan(){
    document.querySelectorAll('.js-plotly-plot, .plotly-graph-div').forEach(bind);
  }
  const obs=new MutationObserver(()=>scan());
  obs.observe(document.documentElement,{childList:true,subtree:true});
  window.addEventListener('load', ()=>{ setTimeout(scan,200); setTimeout(scan,800); setTimeout(scan,1500); });
})();
</script>


<script id="plotlyHoverEnforcer">
(function(){
  function fixLayout(gd){
    if(!gd || !gd.classList || (!gd.classList.contains('js-plotly-plot') && !gd.classList.contains('plotly-graph-div'))) return;
    if(!window.Plotly || !gd._fullLayout) return;

    // Force single-point hover everywhere
    const update = {
      hovermode: 'closest',
      hoverdistance: 8,
      spikedistance: -1
    };

    // Disable spikes if present
    try{
      const axKeys = Object.keys(gd._fullLayout).filter(k=>/^xaxis\d*$|^yaxis\d*$/.test(k));
      axKeys.forEach(k=>{
        update[`${k}.showspikes`] = false;
        update[`${k}.spikesnap`] = 'cursor';
      });
    }catch(e){}

    // Apply without triggering full redraw loop
    window.Plotly.relayout(gd, update).catch(()=>{});
  }

  function scan(){
    document.querySelectorAll('.js-plotly-plot, .plotly-graph-div').forEach(fixLayout);
  }

  // Re-apply after plots render
  const obs = new MutationObserver(()=>scan());
  obs.observe(document.documentElement,{childList:true,subtree:true});
  window.addEventListener('load', ()=>{ setTimeout(scan,300); setTimeout(scan,1000); setTimeout(scan,2000); });
})();
</script>


<script id="noHoverColorShift">
(function(){
  function isSensitiveChart(gd){
    try{
      const t = (gd && gd._fullLayout && gd._fullLayout.title && (gd._fullLayout.title.text||gd._fullLayout.title)) || '';
      const s = String(t).toLowerCase();
      // Match your "users / plan" views (English or Chinese)
      return s.includes('user') || s.includes('用戶') || s.includes('plan') || s.includes('方案');
    }catch(e){ return false; }
  }

  function snapColor(tr){
    // Returns a JSON-serializable "color spec" we can restore
    const out = {};
    if(tr.marker){
      if(tr.marker.color!=null) out.markerColor = tr.marker.color;
      if(tr.marker.line && tr.marker.line.color!=null) out.markerLineColor = tr.marker.line.color;
      if(tr.marker.opacity!=null) out.markerOpacity = tr.marker.opacity;
    }
    if(tr.line){
      if(tr.line.color!=null) out.lineColor = tr.line.color;
      if(tr.line.width!=null) out.lineWidth = tr.line.width;
    }
    if(tr.fillcolor!=null) out.fillcolor = tr.fillcolor;
    if(tr.opacity!=null) out.opacity = tr.opacity;
    return out;
  }

  function restoreTrace(gd, i){
    if(!gd.__origTraceStyles || !gd.__origTraceStyles[i]) return;
    const st = gd.__origTraceStyles[i];
    const update = {};
    if(st.opacity!=null) update.opacity = st.opacity;
    else update.opacity = 1;

    if(st.fillcolor!=null) update.fillcolor = st.fillcolor;

    // marker
    if(st.markerColor!=null){
      update['marker.color'] = st.markerColor;
    }
    if(st.markerLineColor!=null){
      update['marker.line.color'] = st.markerLineColor;
    }
    if(st.markerOpacity!=null){
      update['marker.opacity'] = st.markerOpacity;
    }else{
      // prevent Plotly dimming on hover
      update['marker.opacity'] = 1;
    }

    // line
    if(st.lineColor!=null) update['line.color'] = st.lineColor;
    if(st.lineWidth!=null) update['line.width'] = st.lineWidth;

    try{ window.Plotly && window.Plotly.restyle(gd, update, [i]); }catch(e){}
  }

  function bind(gd){
    if(!gd || gd.__noHoverShiftBound || !gd.on) return;
    gd.__noHoverShiftBound = true;

    // Snapshot original styles after first render
    function snapshot(){
      try{
        if(!gd.data) return;
        gd.__origTraceStyles = gd.data.map(snapColor);
      }catch(e){}
    }
    snapshot();

    // re-snapshot after any relayout/restyle that might recreate traces
    gd.on('plotly_afterplot', snapshot);

    gd.on('plotly_hover', function(e){
      if(!isSensitiveChart(gd)) return;
      try{
        // Restore ALL traces on hover to prevent any transient hover styling
        for(let i=0;i<(gd.data?gd.data.length:0);i++){
          restoreTrace(gd,i);
        }
      }catch(err){}
    });

    gd.on('plotly_unhover', function(){
      if(!isSensitiveChart(gd)) return;
      try{
        for(let i=0;i<(gd.data?gd.data.length:0);i++){
          restoreTrace(gd,i);
        }
      }catch(err){}
    });
  }

  function scan(){
    document.querySelectorAll('.js-plotly-plot, .plotly-graph-div').forEach(bind);
  }
  const obs=new MutationObserver(()=>scan());
  obs.observe(document.documentElement,{childList:true,subtree:true});
  window.addEventListener('load', ()=>{ setTimeout(scan,300); setTimeout(scan,1000); setTimeout(scan,2000); });
})();
</script>


<script id="barHoverProxyNoColorShift">
(function(){
  function getTitle(gd){
    try{
      const t = (gd && gd._fullLayout && gd._fullLayout.title && (gd._fullLayout.title.text||gd._fullLayout.title)) || '';
      return String(t||'');
    }catch(e){ return ''; }
  }
  function isSensitive(gd){
    const s = getTitle(gd).toLowerCase();
    return s.includes('user') || s.includes('用戶') || s.includes('plan') || s.includes('方案');
  }
  function patchBars(gd){
    if(!window.Plotly || !gd || !gd.data || !gd._fullLayout) return;
    if(!isSensitive(gd) || gd.__barHoverProxyPatched) return;

    const barIdx = [];
    gd.data.forEach((tr,i)=>{ if(tr && tr.type==='bar') barIdx.push(i); });
    if(!barIdx.length) return;

    // Disable native hover on bars (prevents Plotly's hover color/outline shift)
    const restyleUpdate = { hoverinfo: [], hovertemplate: [] };
    barIdx.forEach((i)=>{
      restyleUpdate.hoverinfo.push('skip');
      restyleUpdate.hovertemplate.push(null);
    });
    try{
      Plotly.restyle(gd, restyleUpdate, barIdx).catch(()=>{});
    }catch(e){}

    // Add invisible scatter proxies to capture hover without altering bar colors
    const proxies = barIdx.map((i)=>{
      const tr = gd.data[i] || {};
      const x = (tr.x||[]);
      const y = (tr.y||[]);
      const color = (tr.marker && tr.marker.color) ? tr.marker.color : '#ffffff';
      return {
        type: 'scatter',
        mode: 'markers',
        x, y,
        marker: { size: 18, color: color, opacity: 0.001, line: {width: 0} },
        hoverinfo: 'none',
        showlegend: false,
        cliponaxis: false
      };
    });

    gd.__barHoverProxyPatched = true;
    try{
      Plotly.addTraces(gd, proxies).catch(()=>{});
      Plotly.relayout(gd, {hovermode:'closest', hoverdistance:8, spikedistance:-1}).catch(()=>{});
    }catch(e){}
  }

  function scan(){
    document.querySelectorAll('.js-plotly-plot, .plotly-graph-div').forEach((gd)=>{
      try{ if(gd && gd._fullLayout) patchBars(gd); }catch(e){}
    });
  }

  const obs = new MutationObserver(()=>scan());
  obs.observe(document.documentElement,{childList:true,subtree:true});
  window.addEventListener('load', ()=>{ setTimeout(scan,400); setTimeout(scan,1200); setTimeout(scan,2500); });
})();
</script>


<script id="disableHoverForBars_and_TapTooltip">
(function(){
  function getTitle(gd){
    try{
      const t = (gd && gd._fullLayout && gd._fullLayout.title && (gd._fullLayout.title.text||gd._fullLayout.title)) || '';
      return String(t||'');
    }catch(e){ return ''; }
  }
  function isSensitive(gd){
    const s = getTitle(gd).toLowerCase();
    return s.includes('user') || s.includes('用戶') || s.includes('plan') || s.includes('方案');
  }

  // Simple reusable tooltip card (HTML overlay) for click/tap
  const tip = document.createElement('div');
  tip.style.position = 'fixed';
  tip.style.zIndex = '9999';
  tip.style.pointerEvents = 'none';
  tip.style.display = 'none';
  tip.style.padding = '14px 16px';
  tip.style.borderRadius = '18px';
  tip.style.background = 'rgba(10,14,20,0.72)';
  tip.style.backdropFilter = 'blur(10px)';
  tip.style.webkitBackdropFilter = 'blur(10px)';
  tip.style.border = '1px solid rgba(255,255,255,0.10)';
  tip.style.boxShadow = '0 18px 40px rgba(0,0,0,0.45)';
  tip.style.color = '#e8eefc';
  tip.style.fontFamily = 'ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
  tip.style.fontSize = '16px';
  tip.style.lineHeight = '1.25';
  tip.style.maxWidth = '320px';
  document.addEventListener('DOMContentLoaded', ()=>document.body.appendChild(tip));

  function showTip(x,y,html){
    tip.innerHTML = html;
    tip.style.display = 'block';
    // keep on-screen
    const pad = 14;
    const rect = tip.getBoundingClientRect();
    let left = x + 14;
    let top = y + 14;
    if(left + rect.width + pad > window.innerWidth) left = x - rect.width - 14;
    if(top + rect.height + pad > window.innerHeight) top = y - rect.height - 14;
    tip.style.left = Math.max(pad,left) + 'px';
    tip.style.top = Math.max(pad,top) + 'px';
  }
  function hideTip(){ tip.style.display = 'none'; }

  function formatRow(label, value){
    return `<div style="display:flex;gap:12px;justify-content:space-between;align-items:baseline;margin-top:6px;">
      <span style="opacity:.9">${label}</span>
      <span style="font-weight:800;letter-spacing:.2px">${value}</span>
    </div>`;
  }

  function attach(gd){
    if(!window.Plotly || !gd || !gd._fullLayout || gd.__noHoverPatched) return;
    if(!isSensitive(gd)) return;
    gd.__noHoverPatched = true;

    // Disable hover (prevents Plotly hover highlight / color shift)
    try{
      Plotly.relayout(gd, {hovermode:false, hoverdistance:0, spikedistance:-1}).catch(()=>{});
      // Also ensure no hover template on traces
      const idx = gd.data.map((_,i)=>i);
      Plotly.restyle(gd, {hoverinfo:'skip', hovertemplate:null}, idx).catch(()=>{});
    }catch(e){}

    // Tap/Click to show tooltip
    gd.on('plotly_click', function(ev){
      try{
        const pt = ev && ev.points && ev.points[0];
        if(!pt) return;

        const month = (pt.x !== undefined ? pt.x : '');
        const traceName = pt.data && pt.data.name ? pt.data.name : '';
        const val = (pt.y !== undefined ? pt.y : '');

        // If stacked bar, pt has pt.data.name to distinguish (New/Old etc.)
        const title = `<div style="font-weight:900;font-size:22px;margin-bottom:6px;">${month}</div>`;
        const main = formatRow(traceName || 'Value', val);

        const html = title + main;
        const e = ev.event || {};
        const cx = (e.clientX !== undefined) ? e.clientX : (window.innerWidth/2);
        const cy = (e.clientY !== undefined) ? e.clientY : (window.innerHeight/2);
        showTip(cx, cy, html);
      }catch(e){}
    });

    // Hide on background tap/click
    gd.addEventListener('click', function(e){
      // if click didn't originate from a point, plotly_click won't fire; hide
      // delay to allow point-click handler to run first
      setTimeout(()=>{ 
        const active = (gd._hoverdata && gd._hoverdata.length) || false;
        if(!active) hideTip();
      }, 0);
    });

    // Hide on escape
    window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') hideTip(); });

    // On touch scroll/resize, hide
    window.addEventListener('scroll', hideTip, {passive:true});
    window.addEventListener('resize', hideTip);
  }

  function scan(){
    document.querySelectorAll('.js-plotly-plot, .plotly-graph-div').forEach((gd)=>{
      try{ if(gd && gd._fullLayout) attach(gd); }catch(e){}
    });
  }

  const obs = new MutationObserver(()=>scan());
  obs.observe(document.documentElement,{childList:true,subtree:true});
  window.addEventListener('load', ()=>{ setTimeout(scan,600); setTimeout(scan,1600); setTimeout(scan,3000); });
})();
</script>

</body>
</html>
