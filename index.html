<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Fansone Report</title>
<script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
<style>
  :root{
    --bg0:#0b1220; --bg1:#0f1a2e; --panel:rgba(255,255,255,.06); --stroke:rgba(255,255,255,.14);
    --text:#e5e7eb; --muted:#9ca3af;
    --new:#3498db; --old:#2980b9; --rev:#e74c3c; --single:#a78bfa; --totalrev:#f59e0b; --arpu:#d35400;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family: system-ui,-apple-system,sans-serif; color:var(--text);
    background: radial-gradient(1200px 600px at 20% 10%, rgba(52,152,219,.18), transparent 60%),
                radial-gradient(900px 500px at 85% 25%, rgba(231,76,60,.16), transparent 60%),
                linear-gradient(180deg, var(--bg0), var(--bg1));
    min-height:100vh;
  }
  a{color:inherit; text-decoration:none}
  .wrap{max-width:1200px; margin:0 auto; padding:20px 16px 36px}

  /* Topbar & KPI */
  .topbar{ display:flex; justify-content:space-between; gap:14px; padding:14px; border:1px solid var(--stroke); border-radius:16px; background:var(--panel); backdrop-filter:blur(10px); }
  .title h1{margin:0; font-size:18px}
  .title .sub{margin-top:6px; font-size:12px; color:var(--muted)}
  #status.ok{color:#34d399} #status.err{color:#fb7185}

  .kpis{display:flex; gap:10px;}
  .kpi{ padding:12px 14px; border:1px solid var(--stroke); border-radius:16px; background:rgba(255,255,255,.04); min-width:140px; }
  .kpi .klabel{font-size:12px; color:var(--muted); letter-spacing:.5px;}
  .kpi .kvalue{font-size:24px; font-weight:800; margin-top:4px; color:var(--text);}

  /* Grid Layout */
  .grid{display:grid; grid-template-columns: 360px 1fr; gap:14px; margin-top:14px}
  .panel{border:1px solid var(--stroke); border-radius:16px; background:var(--panel); backdrop-filter:blur(10px); overflow:hidden}
  .hd{padding:12px; border-bottom:1px solid rgba(255,255,255,.10); display:flex; align-items:center; justify-content:space-between}
  .hd h2{margin:0; font-size:13px}
  .bd{padding:12px}

  /* Controls */
  .segmented{display:flex; gap:4px; padding:4px; background:rgba(255,255,255,.05); border-radius:12px; margin-bottom:12px;}
  .seg-btn{flex:1; padding:8px; border-radius:8px; border:0; background:transparent; color:var(--muted); font-weight:700; cursor:pointer; transition:.2s;}
  .seg-btn:hover{color:var(--text);}
  .seg-btn.active{background:rgba(255,255,255,.12); color:#fff; box-shadow:0 2px 5px rgba(0,0,0,.1);}

  .checks{display:grid; gap:8px; margin-top:10px}
  .check{ display:flex; gap:10px; align-items:center; padding:10px; border:1px solid var(--stroke); border-radius:14px; background:rgba(255,255,255,.03); cursor:pointer; }
  .check input{width:16px; height:16px; accent-color:var(--new)}
  .dot{width:10px; height:10px; border-radius:50%;}
  .label b{font-size:12px; display:block}
  .label span{font-size:11px; color:var(--muted)}

  /* Chart & Tables */
  #chart{width:100%; height:500px}
  .tablesGrid{display:grid; grid-template-columns: 1.3fr 1fr; gap:14px; margin-top:14px}
  .scroll-box{max-height:340px; overflow:auto;}
  table{width:100%; border-collapse:separate; border-spacing:0; font-size:12px}
  th,td{padding:10px; border-bottom:1px solid rgba(255,255,255,.08)}
  th{text-align:left; color:var(--muted); font-weight:700; background:rgba(15, 26, 46, 0.95); position:sticky; top:0; z-index:2;}
  .right{text-align:right}
  tr:hover td{background:rgba(255,255,255,.05)}
  .pill{padding:4px 8px; border:1px solid var(--stroke); border-radius:20px; font-size:11px; color:var(--muted); background:rgba(255,255,255,.03)}

  /* Custom Tooltip */
  #ttCard{
    position:fixed; z-index:9999; pointer-events:none; display:none;
    padding:12px 14px; border-radius:12px; background:rgba(12,16,24,.85);
    border:1px solid rgba(255,255,255,.14); box-shadow:0 10px 30px rgba(0,0,0,.5);
    backdrop-filter:blur(8px); color:#fff; min-width:160px;
  }
  #ttCard .tt-head{font-weight:800; font-size:13px; margin-bottom:6px; opacity:.9;}
  #ttCard .tt-row{display:flex; align-items:center; gap:8px; font-size:13px;}
  #ttCard .tt-val{margin-left:auto; font-weight:700;}

  @media (max-width: 900px){
    .grid, .tablesGrid{grid-template-columns: 1fr}
    .topbar{flex-direction:column;}
    .kpis{width:100%; display:grid; grid-template-columns:1fr 1fr;}
    #chart{height:350px}
  }
</style>
</head>
<body>

<div class="wrap">
  <div class="topbar">
    <div class="title">
      <h1>Fansone Report</h1>
      <div class="sub" id="status">Connecting...</div>
    </div>
    <div class="kpis">
      <div class="kpi">
        <div class="klabel">Latest Month</div>
        <div class="kvalue" id="kpiMonth">–</div>
      </div>
      <div class="kpi">
        <div class="klabel">Total Revenue</div>
        <div class="kvalue" id="kpiTotal">–</div>
      </div>
    </div>
  </div>

  <div class="grid">
    <div class="panel">
      <div class="hd"><h2>Chart Controls</h2></div>
      <div class="bd">
        <div class="segmented" id="chartViewSeg">
          <button class="seg-btn active" data-val="money">Revenue</button>
          <button class="seg-btn" data-val="subs">Subs</button>
          <button class="seg-btn" data-val="mix">Plans</button>
          <button class="seg-btn" data-val="arpu">ARPU</button>
        </div>
        <div class="checks" id="traceChecks"></div>
        <div style="margin-top:14px; font-size:11px; color:var(--muted); text-align:center">
           Click legend to toggle lines • Double click to isolate
        </div>
      </div>
    </div>
    <div class="panel" style="padding:4px">
      <div id="chart"></div>
    </div>
  </div>

  <div class="tablesGrid">
    <div class="panel">
      <div class="hd"><h2>Monthly Summary</h2><span class="pill">Sub + Single</span></div>
      <div class="bd scroll-box">
        <table id="monthlyTable">
          <thead>
            <tr><th>Month</th><th class="right">Subs</th><th class="right">New</th><th class="right">Old</th><th class="right">Sub $</th><th class="right">Single $</th><th class="right">Total $</th><th class="right">ARPU</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="panel">
      <div class="hd">
        <h2>Top Users</h2>
        <div class="segmented" id="userSeg" style="margin:0; padding:2px; font-size:11px;">
          <button class="seg-btn active" data-metric="totalSpend">Spend</button>
          <button class="seg-btn" data-metric="monthsActive">Loyalty</button>
        </div>
      </div>
      <div class="bd scroll-box">
        <table id="userTable">
          <thead><tr><th>User ID</th><th class="right">Metric</th><th class="right">Sub $</th><th class="right">Total $</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="tablesGrid" style="grid-template-columns:1fr">
    <div class="panel">
      <div class="hd"><h2>Top Single Sales</h2><span class="pill">Top 10</span></div>
      <div class="bd scroll-box">
        <table>
          <thead><tr><th>Title</th><th class="right">Revenue</th><th class="right">Orders</th></tr></thead>
          <tbody id="singleTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<div id="ttCard"><div class="tt-head"></div><div class="tt-body"></div></div>

<script>
// --- Config & Utils ---
const URLs = {
  SUB: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQiAPNDCD7qn6atO4VB6Ei63AacDK00AMKM16hK8c-wVWFadPPOj-P8olYQ-ofMFwy0maGU1A4CBneW/pub?gid=0&single=true&output=csv",
  SINGLE: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQiAPNDCD7qn6atO4VB6Ei63AacDK00AMKM16hK8c-wVWFadPPOj-P8olYQ-ofMFwy0maGU1A4CBneW/pub?gid=1226262547&single=true&output=csv"
};

const el = id => document.getElementById(id);
const fmtMoney = n => isFinite(n) ? "$ " + Math.round(n).toLocaleString() : "–";
const fmtInt = n => isFinite(n) ? Math.round(n).toLocaleString() : "0";

// --- Data Fetching & Processing ---
async function fetchData() {
  const parseCSV = (text) => {
    const rows = text.replace(/\r/g,"").trim().split("\n");
    if(rows.length < 2) return [];

    // Split headers carefully
    const headers = rows[0].split(",").map(h => h.trim().replace(/^"|"$/g, '').toLowerCase());

    return rows.slice(1).map(r => {
      // Handle quoted CSV cells better
      const cells = [];
      let cur = "", inQ = false;
      for(let i=0; i<r.length; i++){
        let c = r[i];
        if(c === '"'){
           if(inQ && r[i+1] === '"'){ cur += '"'; i++; } // handle escaped quote
           else { inQ = !inQ; }
        } else if(c === ',' && !inQ){
           cells.push(cur); cur = "";
        } else {
           cur += c;
        }
      }
      cells.push(cur);

      const obj = {};
      headers.forEach((h, i) => obj[h] = (cells[i] || "").trim());
      return obj;
    });
  };

  try {
    if(location.protocol === "file:") {
      el("status").className = "sub err";
      el("status").textContent = "File protocol blocked. Please use localhost or Vercel.";
      return null;
    }
    const [r1, r2] = await Promise.all([fetch(URLs.SUB), fetch(URLs.SINGLE)]);
    if(!r1.ok || !r2.ok) throw new Error("Network error");

    return {
      subs: parseCSV(await r1.text()),
      singles: parseCSV(await r2.text())
    };
  } catch(e) {
    el("status").className = "sub err";
    el("status").textContent = "Error: " + e.message;
    throw e;
  }
}

function processData(rawSub, rawSingle) {
  // Helper: Find columns using multiple aliases (Chinese/English)
  const findCol = (row, ...keywords) => {
    const rowKeys = Object.keys(row);
    // Try exact match first, then includes
    for(const k of rowKeys) {
      if(keywords.some(kw => k === kw || k.includes(kw))) return row[k];
    }
    return "";
  };

  const parsePrice = s => {
    const m = String(s).match(/-?\d+(?:,\d{3})*(?:\.\d+)?/);
    return m ? parseFloat(m[0].replace(/,/g, "")) : 0;
  };

  const getMonth = (s) => {
    const m = String(s).match(/(\d{4})-(\d{2})/);
    return m ? `${m[1]}-${m[2]}` : null;
  };

  const monthMap = new Map();
  const userMap = new Map();
  const singleAgg = new Map();

  const ensureMonth = (m) => {
    if(!monthMap.has(m)) monthMap.set(m, { month:m, subs:new Set(), newU:new Set(), oldU:new Set(), plans:{p1:0,p3:0,p6:0}, revSub:0, revSingle:0 });
    return monthMap.get(m);
  };
  const ensureUser = (id) => {
    if(!userMap.has(id)) userMap.set(id, { id, sub$:0, single$:0, total$:0, months:new Set() });
    return userMap.get(id);
  };

  // 1. Process Subs
  // Sort by time safely to determine New vs Old
  rawSub.sort((a,b) => {
    const ta = findCol(a, "time", "date", "時間") || "";
    const tb = findCol(b, "time", "date", "時間") || "";
    return ta.localeCompare(tb);
  });

  const seenUsers = new Set();

  rawSub.forEach(row => {
    const timeStr = findCol(row, "time", "date", "時間", "datetime");
    const m = getMonth(timeStr);
    if(!m) return;

    const id = findCol(row, "user", "id", "用戶", "userid");
    const plan = findCol(row, "plan", "方案", "類型").toLowerCase();
    const price = parsePrice(findCol(row, "price", "金額", "amount", "收入", "價格"));

    const md = ensureMonth(m);

    if(id) {
      if(!md.subs.has(id)) {
        md.subs.add(id);
        if(seenUsers.has(id)) md.oldU.add(id); else md.newU.add(id);
        seenUsers.add(id);
      }
      const u = ensureUser(id);
      u.sub$ += price; u.total$ += price; u.months.add(m);
    }

    if(isFinite(price)) md.revSub += price;

    if(plan.includes("6") || plan.includes("半") || plan.includes("six")) md.plans.p6++;
    else if(plan.includes("3") || plan.includes("三") || plan.includes("three")) md.plans.p3++;
    else md.plans.p1++;
  });

  // 2. Process Singles
  rawSingle.forEach(row => {
    const timeStr = findCol(row, "time", "date", "時間");
    const m = getMonth(timeStr);
    const title = findCol(row, "title", "標題", "內容", "影片");
    const price = parsePrice(findCol(row, "price", "金額", "amount", "收入", "價格"));
    const id = findCol(row, "user", "id", "用戶");
    const url = findCol(row, "url", "link", "網址");

    if(m) {
      const md = ensureMonth(m);
      if(isFinite(price)) md.revSingle += price;
    }

    if(id) {
      const u = ensureUser(id);
      if(isFinite(price)) { u.single$ += price; u.total$ += price; }
      if(m) u.months.add(m);
    }

    if(title) {
      if(!singleAgg.has(title)) singleAgg.set(title, { title, sum:0, count:0, url });
      const t = singleAgg.get(title);
      if(isFinite(price)) t.sum += price;
      t.count++;
    }
  });

  // 3. Final Aggregation
  const monthly = Array.from(monthMap.values()).sort((a,b) => a.month.localeCompare(b.month)).map(d => {
    const totalRev = d.revSub + d.revSingle;
    const subCount = d.subs.size;
    const planTotal = d.plans.p1 + d.plans.p3 + d.plans.p6 || 1;
    return {
      ...d,
      totalRev,
      newCnt: d.newU.size,
      oldCnt: d.oldU.size,
      arpu: subCount ? d.revSub / subCount : 0,
      mix: { p1: d.plans.p1/planTotal*100, p3: d.plans.p3/planTotal*100, p6: d.plans.p6/planTotal*100 }
    };
  });

  return {
    monthly,
    users: Array.from(userMap.values()),
    singles: Array.from(singleAgg.values()).sort((a,b) => b.sum - a.sum).slice(0, 10)
  };
}

// --- Rendering Logic ---
let STATE = { monthly: [], users: [], singles: [] };
let CHART = null;

function renderTables() {
  if(!STATE.monthly.length) return;

  // Monthly Table
  const revM = [...STATE.monthly].reverse();
  el("monthlyTable").querySelector("tbody").innerHTML = revM.map(d => `
    <tr>
      <td>${d.month}</td>
      <td class="right">${d.subs.size}</td>
      <td class="right" style="color:var(--new)">${d.newCnt}</td>
      <td class="right" style="color:var(--old)">${d.oldCnt}</td>
      <td class="right">${fmtInt(d.revSub)}</td>
      <td class="right" style="color:var(--muted)">${fmtInt(d.revSingle)}</td>
      <td class="right" style="font-weight:bold">${fmtInt(d.totalRev)}</td>
      <td class="right">${d.arpu.toFixed(1)}</td>
    </tr>
  `).join("");

  // Single Sales Table
  el("singleTableBody").innerHTML = STATE.singles.map(s => `
    <tr>
      <td>${s.url ? `<a href="${s.url}" target="_blank">${s.title}</a>` : s.title}</td>
      <td class="right">${fmtInt(s.sum)}</td>
      <td class="right">${s.count}</td>
    </tr>
  `).join("");

  renderUsers("totalSpend");
}

function renderUsers(metric) {
  const users = [...STATE.users];
  if(metric === "totalSpend") users.sort((a,b) => b.total$ - a.total$);
  else if(metric === "monthsActive") users.sort((a,b) => b.months.size - a.months.size);

  const top10 = users.slice(0, 10);
  const metricVal = (u) => metric === "totalSpend" ? fmtMoney(u.total$) : u.months.size + " mo";

  el("userTable").querySelector("tbody").innerHTML = top10.map(u => `
    <tr>
      <td style="font-family:monospace; opacity:.8">${u.id}</td>
      <td class="right"><b>${metricVal(u)}</b></td>
      <td class="right">${fmtInt(u.sub$)}</td>
      <td class="right">${fmtInt(u.total$)}</td>
    </tr>
  `).join("") || `<tr><td colspan="4" style="text-align:center; padding:10px; color:var(--muted)">Loading...</td></tr>`;
}

function renderKPIs() {
  if(!STATE.monthly.length) return;
  const last = STATE.monthly[STATE.monthly.length - 1];
  const total = STATE.monthly.reduce((a, b) => a + b.totalRev, 0);
  el("kpiMonth").textContent = fmtMoney(last.totalRev);
  el("kpiTotal").textContent = fmtMoney(total);
}

// --- Plotly Chart ---
function initChart() {
  const config = { responsive: true, displayModeBar: false };
  const layout = {
    paper_bgcolor: "rgba(0,0,0,0)",
    plot_bgcolor: "rgba(255,255,255,0.02)",
    margin: { l:40, r:20, t:20, b:40 },
    xaxis: { tickcolor: "rgba(255,255,255,0.1)", gridcolor: "rgba(255,255,255,0.05)", tickfont:{color:"#9ca3af"} },
    yaxis: { tickcolor: "rgba(255,255,255,0.1)", gridcolor: "rgba(255,255,255,0.05)", tickfont:{color:"#9ca3af"} },
    legend: { orientation: "h", y: 1.1, font:{color:"#9ca3af"} },
    hovermode: "closest",
  };
  Plotly.newPlot("chart", [], layout, config).then(gd => {
    CHART = gd;
    setupTooltip(gd);
  });
}

function updateChart(view) {
  if(!STATE.monthly || !STATE.monthly.length) return;

  const m = STATE.monthly;
  const x = m.map(d => d.month);
  let traces = [];
  let checks = [];
  const css = getComputedStyle(document.body);
  const c = {
    new: css.getPropertyValue("--new").trim(),
    old: css.getPropertyValue("--old").trim(),
    rev: css.getPropertyValue("--rev").trim(),
    tot: css.getPropertyValue("--totalrev").trim(),
    sng: css.getPropertyValue("--single").trim()
  };

  if(view === "money") {
    traces = [
      { name:"Total", x, y:m.map(d=>d.totalRev), type:"scatter", mode:"lines+markers", line:{color:c.tot, width:3}, visible:true },
      { name:"Sub Only", x, y:m.map(d=>d.revSub), type:"scatter", mode:"lines+markers", line:{color:c.rev}, visible:true },
      { name:"Single", x, y:m.map(d=>d.revSingle), type:"scatter", mode:"lines+markers", line:{color:c.sng, dash:"dot"}, visible:true }
    ];
    checks = [{id:0, l:"Total"}, {id:1, l:"Sub Only"}, {id:2, l:"Single Sales"}];
  } else if(view === "subs") {
    traces = [
      { name:"New", x, y:m.map(d=>d.newCnt), type:"bar", marker:{color:c.new}, visible:true },
      { name:"Old", x, y:m.map(d=>d.oldCnt), type:"bar", marker:{color:c.old}, visible:true }
    ];
    checks = [{id:0, l:"New Users"}, {id:1, l:"Old Users"}];
    Plotly.relayout(CHART, {barmode:"stack"});
  } else if(view === "mix") {
    traces = [
      { name:"1M", x, y:m.map(d=>d.mix.p1), type:"bar", marker:{color:"#22c55e"}, visible:true },
      { name:"3M", x, y:m.map(d=>d.mix.p3), type:"bar", marker:{color:"#60a5fa"}, visible:true },
      { name:"6M", x, y:m.map(d=>d.mix.p6), type:"bar", marker:{color:"#f97316"}, visible:true }
    ];
    checks = [{id:0, l:"1M %"}, {id:1, l:"3M %"}, {id:2, l:"6M %"}];
    Plotly.relayout(CHART, {barmode:"stack", "yaxis.range":[0,100]});
  } else if(view === "arpu") {
    traces = [{ name:"ARPU", x, y:m.map(d=>d.arpu), type:"scatter", mode:"lines+markers", line:{color:css.getPropertyValue("--arpu").trim(), width:3}, visible:true }];
  }

  Plotly.react(CHART, traces, CHART.layout);

  // Render Checkboxes
  const box = el("traceChecks");
  box.innerHTML = checks.map(c => `
    <label class="check">
      <input type="checkbox" checked data-idx="${c.id}">
      <span class="dot" style="background:${traces[c.id].marker?.color || traces[c.id].line?.color}"></span>
      <span class="label"><b>${c.l}</b></span>
    </label>
  `).join("");

  box.querySelectorAll("input").forEach(cb => {
    cb.addEventListener("change", (e) => {
      Plotly.restyle(CHART, {visible: e.target.checked}, [parseInt(e.target.dataset.idx)]);
    });
  });
}

// --- Custom Tooltip ---
function setupTooltip(gd) {
  const card = el("ttCard");
  const head = card.querySelector(".tt-head");
  const body = card.querySelector(".tt-body");

  gd.on('plotly_hover', data => {
    const pt = data.points[0];
    // Position
    const bbox = pt.xaxis.layer.getBoundingClientRect();
    const x = data.event ? data.event.clientX : (bbox.x + pt.xaxis.d2p(pt.x));
    const y = data.event ? data.event.clientY : (bbox.y + pt.yaxis.d2p(pt.y));

    card.style.display = "block";
    card.style.top = (y - 10) + "px";
    card.style.left = (x + 15) + "px";
    if(x > window.innerWidth - 180) card.style.left = (x - 170) + "px";

    head.textContent = pt.x;

    // Show all visible traces for this X
    const vals = gd.data.map((tr, i) => {
      if(tr.visible === false || tr.visible === "legendonly") return null;
      const val = tr.y[pt.pointNumber];
      if(val == null) return null;

      let valStr = isFinite(val) ? Math.round(val).toLocaleString() : val;
      if(tr.name.includes("M")) valStr += "%";
      if(tr.name.includes("Rev") || tr.name.includes("Total") || tr.name.includes("Sub")) valStr = "$ " + valStr;

      const c = tr.marker?.color || tr.line?.color || "#fff";
      return `<div class="tt-row"><div class="dot" style="background:${c}"></div> ${tr.name} <span class="tt-val">${valStr}</span></div>`;
    }).filter(x=>x).join("");

    body.innerHTML = vals;
  });

  gd.on('plotly_unhover', () => card.style.display = "none");
}

// --- Init ---
(async function main() {
  initChart();

  // Controls
  el("chartViewSeg").querySelectorAll("button").forEach(btn => {
    btn.addEventListener("click", () => {
      el("chartViewSeg").querySelector(".active").classList.remove("active");
      btn.classList.add("active");
      updateChart(btn.dataset.val);
    });
  });

  el("userSeg").querySelectorAll("button").forEach(btn => {
    btn.addEventListener("click", () => {
      el("userSeg").querySelector(".active").classList.remove("active");
      btn.classList.add("active");
      renderUsers(btn.dataset.metric);
    });
  });

  // Load Data
  try {
    const raw = await fetchData();
    if(raw) {
      STATE = processData(raw.subs, raw.singles);

      el("status").className = "sub ok";
      el("status").textContent = "Updated: " + new Date().toLocaleTimeString();

      renderKPIs();
      renderTables();
      updateChart("money");
    }
  } catch(e) { console.error(e); }
})();
</script>
</body>
</html>
