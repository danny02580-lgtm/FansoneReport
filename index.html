<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fansone Report｜月報表</title>
  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f172a;
      --panel2:#0b1326;
      --border:rgba(148,163,184,.22);
      --grid:rgba(148,163,184,.18);
      --text:#e5e7eb;
      --muted:#9ca3af;

      --new:#3498db;   /* light blue */
      --old:#2980b9;   /* deep blue  */
      --rev:#e74c3c;   /* bright red */
      --arpu:#d35400;  /* deep orange */
      --single:#a855f7;/* vivid purple */
      --m1:#22c55e;    /* green */
      --m3:#f59e0b;    /* amber */
      --m6:#ef4444;    /* red */
    }
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg, #0b1220 0%, #0a1020 45%, #0b1220 100%);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{max-width:1180px;margin:0 auto;padding:16px 14px 24px}
    .top{
      background:rgba(15,23,42,.88);
      border:1px solid var(--border);
      border-radius:16px;
      padding:14px 14px;
      display:flex;justify-content:space-between;gap:12px;align-items:center;flex-wrap:wrap;
      box-shadow:0 10px 30px rgba(0,0,0,.22);
    }
    .title{font-weight:900;letter-spacing:.2px}
    .muted{color:var(--muted);font-size:12px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .panel{
      margin-top:14px;
      background:rgba(2,6,23,.70);
      border:1px solid rgba(59,130,246,.20);
      border-radius:16px;
      padding:14px;
      box-shadow:0 10px 30px rgba(0,0,0,.18);
    }
    .controls{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;
      margin-bottom:8px
    }
    select,.btn{
      background:rgba(5,10,22,.92);
      color:var(--text);
      border:1px solid var(--border);
      border-radius:12px;
      padding:9px 10px;
      font-weight:800;
      outline:none;
    }
    .btn{cursor:pointer}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .checkgrid{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .chk{
      display:flex;gap:6px;align-items:center;
      padding:6px 10px;border-radius:999px;
      border:1px solid var(--border);
      background:rgba(5,10,22,.75);
      font-size:12px;color:var(--text);
      user-select:none;
    }
    .chk input{accent-color:#60a5fa}
    #chart{width:100%;height:520px}
    .split{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
      margin-top:12px;
    }
    @media (min-width: 980px){
      .split{grid-template-columns: 1.15fr .85fr;}
    }
    .mini{
      background:rgba(15,23,42,.55);
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
    }
    .mini h3{margin:0 0 6px 0;font-size:14px}
    table{width:100%;border-collapse:collapse;font-size:12px}
    th,td{padding:8px 8px;border-bottom:1px solid rgba(148,163,184,.14);text-align:left;vertical-align:top}
    th{color:#cbd5e1;font-weight:900}
    .right{text-align:right}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--border);color:#cbd5e1;font-size:12px}
    a{color:#93c5fd}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <div class="title">Fansone Report｜月報表</div>
        <div class="muted" id="subline">Loading…</div>
      </div>
      <div class="row">
        <span class="badge" id="rangeBadge">—</span>
        <button class="btn" id="reloadBtn">Reload</button>
      </div>
    </div>

    <div class="panel">
      <div class="controls">
        <div class="row">
          <label class="muted" style="font-weight:800">View</label>
          <select id="viewSelect">
            <option value="subs">訂閱人數｜New vs Old</option>
            <option value="mix">方案比例｜1M/3M/6M</option>
            <option value="rev">訂閱營收｜Subscription Revenue</option>
            <option value="single">單片購買｜Single Revenue</option>
            <option value="totalrev">總營收｜Total Revenue</option>
            <option value="arpu">ARPU｜每人平均營收</option>
            <option value="money">金額疊加｜Sub + Single (+ ARPU)</option>
          </select>
        </div>
        <div class="checkgrid" id="traceToggles"></div>
      </div>
      <div id="chart"></div>

      <!-- Single purchase info moved BELOW to keep page not too wide -->
      <div class="split">
        <div class="mini">
          <h3>Monthly Summary｜月度總表</h3>
          <div class="muted">Newest → Oldest</div>
          <div class="scroll">
            <table id="monthlyTable"></table>
          </div>
        </div>

        <div class="mini">
          <h3>Top Single Purchases｜單片TOP</h3>
          <div class="muted">By revenue (title aggregated)｜依金額彙總</div>
          <div class="scroll">
            <table id="topSinglesTable"></table>
          </div>
        </div>
      </div>
    </div>

    <div class="panel">
      <div class="muted">
        Data sources (CSV):<br/>
        Subscriptions: <a id="subUrl" href="#" target="_blank" rel="noreferrer">open</a><br/>
        Single purchases: <a id="singleUrl" href="#" target="_blank" rel="noreferrer">open</a>
      </div>
    </div>
  </div>

<script>
const SUB_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQiAPNDCD7qn6atO4VB6Ei63AacDK00AMKM16hK8c-wVWFadPPOj-P8olYQ-ofMFwy0maGU1A4CBneW/pub?gid=0&single=true&output=csv";
const SINGLE_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQiAPNDCD7qn6atO4VB6Ei63AacDK00AMKM16hK8c-wVWFadPPOj-P8olYQ-ofMFwy0maGU1A4CBneW/pub?gid=1226262547&single=true&output=csv";

document.getElementById("subUrl").href = SUB_CSV_URL;
document.getElementById("singleUrl").href = SINGLE_CSV_URL;

const el = (id)=>document.getElementById(id);

// --- CSV parsing with quotes support ---
function parseCSV(text){
  const rows = [];
  let cur = [], field = "", inQuotes = false;
  for(let i=0;i<text.length;i++){
    const c = text[i];
    if(inQuotes){
      if(c === '"'){
        if(text[i+1] === '"'){ field += '"'; i++; }
        else inQuotes = false;
      } else field += c;
    } else {
      if(c === '"') inQuotes = true;
      else if(c === ','){ cur.push(field); field=""; }
      else if(c === '\n'){
        cur.push(field); field="";
        // trim possible \r
        if(cur.length===1 && cur[0].trim()===""){ cur=[]; continue; }
        rows.push(cur.map(x=>x.replace(/\r/g,"")));
        cur=[];
      } else field += c;
    }
  }
  if(field.length || cur.length){
    cur.push(field);
    rows.push(cur.map(x=>x.replace(/\r/g,"")));
  }
  return rows;
}

function toNumberMoney(x){
  if(x==null) return 0;
  const m = String(x).match(/([0-9]+(?:\.[0-9]+)?)/);
  return m ? Number(m[1]) : 0;
}
function normTime(t){
  t = String(t||"").trim();
  const m = t.match(/^(\d{4}-\d{2}-\d{2})(\d{2}:\d{2}:\d{2})$/);
  if(m) return m[1]+" "+m[2];
  const m2 = t.match(/^(\d{4}-\d{2}-\d{2})\s+(\d{2}:\d{2}:\d{2})$/);
  if(m2) return m2[1]+" "+m2[2];
  const m3 = t.match(/^(\d{4}-\d{2}-\d{2})(\d{2}:\d{2}:\d{2}).*$/);
  if(m3) return m3[1]+" "+m3[2];
  return t;
}
function monthKeyFromTime(t){
  t = normTime(t);
  const m = t.match(/^(\d{4})-(\d{2})-/);
  return m ? (m[1]+"-"+m[2]) : "";
}
function planNorm(p){
  p = String(p||"").trim();
  if(/^1m$/i.test(p)) return "1M";
  if(/^3m$/i.test(p)) return "3M";
  if(/^6m$/i.test(p)) return "6M";
  if(/1\s*個月/.test(p)) return "1M";
  if(/3\s*個月/.test(p)) return "3M";
  if(/6\s*個月/.test(p)) return "6M";
  const mm = p.match(/(?:^|\/)(1|3|6)\s*個月/);
  if(mm) return mm[1]+"M";
  return p;
}
function yyyymmSortAsc(a,b){ return a.localeCompare(b); } // works for YYYY-MM
function yyyymmSortDesc(a,b){ return b.localeCompare(a); }

async function fetchTable(url){
  const r = await fetch(url, {cache:"no-store"});
  if(!r.ok) throw new Error("Fetch failed: "+r.status);
  const txt = await r.text();
  const raw = parseCSV(txt);
  const header = raw[0].map(h=>h.trim());
  const data = raw.slice(1).filter(row => row.some(v => String(v||"").trim()!==""));
  return {header, data};
}

function buildMonthly(subRows, singleRows){
  // Sub rows: time, plan, user_id, price, fee
  // Single rows: time, title, url, user_id, price, fee

  // Parse and normalize
  const subs = subRows.map(r=>({
    time: normTime(r.time),
    month: monthKeyFromTime(r.time),
    plan: planNorm(r.plan),
    user_id: String(r.user_id||"").trim(),
    price: toNumberMoney(r.price),
    fee: toNumberMoney(r.fee)
  })).filter(x=>x.month && x.user_id);

  const singles = singleRows.map(r=>({
    time: normTime(r.time),
    month: monthKeyFromTime(r.time),
    title: String(r.title||"").trim(),
    url: String(r.url||"").trim(),
    user_id: String(r.user_id||"").trim(),
    price: toNumberMoney(r.price),
    fee: toNumberMoney(r.fee)
  })).filter(x=>x.month && x.user_id);

  // months union
  const monthsSet = new Set([...subs.map(s=>s.month), ...singles.map(s=>s.month)]);
  const monthsAsc = [...monthsSet].sort(yyyymmSortAsc);

  // Build "latest plan per user per month" for plan mix & subscriber counting
  // key = month|user_id -> keep latest by time string
  const latestPlanByUserMonth = new Map();
  for(const s of subs){
    const key = s.month+"|"+s.user_id;
    const prev = latestPlanByUserMonth.get(key);
    if(!prev || s.time > prev.time){
      latestPlanByUserMonth.set(key, {time:s.time, plan:s.plan});
    }
  }

  // For new/old: consider month order ascending (oldest->newest)
  const seenBefore = new Set();
  const monthAgg = new Map();

  for(const m of monthsAsc){
    // subscribers: unique users in that month (from subs, using latest plan map)
    const userSet = new Set();
    const planCount = { "1M":0, "3M":0, "6M":0 };
    for(const [key,val] of latestPlanByUserMonth.entries()){
      if(key.startsWith(m+"|")){
        const user_id = key.split("|")[1];
        userSet.add(user_id);
        if(planCount[val.plan]!=null) planCount[val.plan] += 1;
      }
    }
    const subscribers = userSet.size;

    // new/old counts based on "seenBefore"
    let newUsers = 0, oldUsers = 0;
    for(const u of userSet){
      if(seenBefore.has(u)) oldUsers++;
      else newUsers++;
    }
    // after classifying this month, add to seen
    for(const u of userSet) seenBefore.add(u);

    // revenue (subscriptions): sum of all subscription rows in that month
    const subRevenue = subs.filter(x=>x.month===m).reduce((a,b)=>a+b.price,0);

    // single revenue
    const singleRevenue = singles.filter(x=>x.month===m).reduce((a,b)=>a+b.price,0);

    // ARPU (subscription revenue / subscribers)
    const arpu = subscribers ? (subRevenue / subscribers) : 0;

    monthAgg.set(m, {
      month:m,
      subscribers,
      newUsers,
      oldUsers,
      planCount,
      subRevenue,
      singleRevenue,
      arpu
    });
  }

  // growth rates (vs previous month) on ASC, then we'll display DESC
  const monthsWithGrowthAsc = monthsAsc.map((m, i)=>{
    const cur = monthAgg.get(m);
    const prev = i>0 ? monthAgg.get(monthsAsc[i-1]) : null;
    const subsGrowth = prev && prev.subscribers ? ((cur.subscribers - prev.subscribers)/prev.subscribers)*100 : null;
    const revGrowth  = prev && prev.subRevenue ? ((cur.subRevenue - prev.subRevenue)/prev.subRevenue)*100 : null;
    return {...cur, subsGrowth, revGrowth};
  });

  // Display order: newest -> oldest
  const monthsDesc = [...monthsAsc].sort(yyyymmSortDesc);
  const aggDesc = monthsDesc.map(m => monthsWithGrowthAsc.find(x=>x.month===m)).filter(Boolean);

  // Top singles (overall)
  const titleAgg = new Map();
  for(const s of singles){
    const key = s.title || "(untitled)";
    const prev = titleAgg.get(key) || {title:key, revenue:0, count:0, exampleUrl:s.url};
    prev.revenue += s.price;
    prev.count += 1;
    if(!prev.exampleUrl && s.url) prev.exampleUrl = s.url;
    titleAgg.set(key, prev);
  }
  const topSingles = [...titleAgg.values()].sort((a,b)=>b.revenue-a.revenue).slice(0, 12);

  return { monthsAsc, monthsDesc, aggDesc, topSingles };
}

function plotView(view, aggDesc){
  const months = aggDesc.map(x=>x.month); // newest -> oldest
  const x = months;

  const toggles = el("traceToggles");
  toggles.innerHTML = "";

  function addToggle(id, label, checked=true){
    const w = document.createElement("label");
    w.className = "chk";
    w.innerHTML = `<input type="checkbox" id="${id}" ${checked?"checked":""}/> <span>${label}</span>`;
    toggles.appendChild(w);
  }

  let traces = [];
  let layout = {
    paper_bgcolor:"rgba(0,0,0,0)",
    plot_bgcolor:"rgba(0,0,0,0)",
    margin:{l:52,r:52,t:14,b:46},
    font:{color:"#e5e7eb", family:"system-ui, -apple-system, Segoe UI"},
    xaxis:{tickfont:{color:"#cbd5e1"}, gridcolor:"rgba(148,163,184,.0)", zerolinecolor:"rgba(148,163,184,.0)"},
    yaxis:{tickfont:{color:"#cbd5e1"}, gridcolor:"rgba(148,163,184,.18)", zerolinecolor:"rgba(148,163,184,.0)"},
    legend:{orientation:"h", yanchor:"bottom", y:1.02, xanchor:"left", x:0},
    hoverlabel:{bgcolor:"rgba(15,23,42,.95)", bordercolor:"rgba(148,163,184,.35)", font:{color:"#e5e7eb"}}
  };

  if(view==="subs"){
    addToggle("t_new","New users｜新客", true);
    addToggle("t_old","Old users｜舊客", true);
    addToggle("t_total","Total｜總數", false);

    const newUsers = aggDesc.map(x=>x.newUsers);
    const oldUsers = aggDesc.map(x=>x.oldUsers);
    const total = aggDesc.map(x=>x.subscribers);

    traces = [
      {name:"New users", x, y:newUsers, type:"bar", marker:{color:getComputedStyle(document.documentElement).getPropertyValue('--new').trim()}, hovertemplate:"%{x}<br>New: <b>%{y}</b><extra></extra>", visible:true},
      {name:"Old users", x, y:oldUsers, type:"bar", marker:{color:getComputedStyle(document.documentElement).getPropertyValue('--old').trim()}, hovertemplate:"%{x}<br>Old: <b>%{y}</b><extra></extra>", visible:true},
      {name:"Total", x, y:total, type:"scatter", mode:"lines+markers+text",
        line:{color:"#e5e7eb", width:2}, marker:{size:7, color:"#e5e7eb"},
        text: total.map(v=>String(v)), textposition:"top center", textfont:{size:12, color:"#e5e7eb", family:"system-ui",},
        hovertemplate:"%{x}<br>Total: <b>%{y}</b><extra></extra>", visible:false}
    ];
    layout.barmode="stack";
    layout.yaxis.title = "";
  }

  if(view==="mix"){
    addToggle("t_1m","1M｜單月", true);
    addToggle("t_3m","3M｜三月", true);
    addToggle("t_6m","6M｜六月", true);

    // plan mix as stacked 100% bars
    const c1 = aggDesc.map(x=>x.planCount["1M"]||0);
    const c3 = aggDesc.map(x=>x.planCount["3M"]||0);
    const c6 = aggDesc.map(x=>x.planCount["6M"]||0);
    const total = c1.map((_,i)=> (c1[i]+c3[i]+c6[i]) || 1);
    const p1 = c1.map((v,i)=> v/total[i]*100);
    const p3 = c3.map((v,i)=> v/total[i]*100);
    const p6 = c6.map((v,i)=> v/total[i]*100);

    traces = [
      {name:"1M", x, y:p1, type:"bar", marker:{color:getComputedStyle(document.documentElement).getPropertyValue('--m1').trim()},
       hovertemplate:"%{x}<br>1M: <b>%{y:.1f}%</b><extra></extra>"},
      {name:"3M", x, y:p3, type:"bar", marker:{color:getComputedStyle(document.documentElement).getPropertyValue('--m3').trim()},
       hovertemplate:"%{x}<br>3M: <b>%{y:.1f}%</b><extra></extra>"},
      {name:"6M", x, y:p6, type:"bar", marker:{color:getComputedStyle(document.documentElement).getPropertyValue('--m6').trim()},
       hovertemplate:"%{x}<br>6M: <b>%{y:.1f}%</b><extra></extra>"},
    ];
    layout.barmode="stack";
    layout.yaxis.range=[0,100];
    layout.yaxis.ticksuffix="%";
  }

  if(view==="rev"){
    addToggle("t_rev","Revenue｜訂閱營收", true);
    const rev = aggDesc.map(x=>x.subRevenue);
    const total = aggDesc.map(x=>x.subRevenue + x.singleRevenue);
    traces = [
      {name:"Revenue", x, y:rev, type:"scatter", mode:"lines+markers+text",
       line:{color:getComputedStyle(document.documentElement).getPropertyValue('--rev').trim(), width:3},
       marker:{size:8, color:getComputedStyle(document.documentElement).getPropertyValue('--rev').trim()},
       text: rev.map(v=>String(Math.round(v))), textposition:"top center", textfont:{size:12, color:"#e5e7eb"},
       hovertemplate:"%{x}<br>Revenue: <b>%{y}</b><extra></extra>"}
    ];
    layout.yaxis.title="";
  }

  if(view==="single"){
    addToggle("t_single","Single revenue｜單片營收", true);
    const sr = aggDesc.map(x=>x.singleRevenue);
    traces = [
      {name:"Single purchase revenue", x, y:sr, type:"scatter", mode:"lines+markers+text",
       line:{color:getComputedStyle(document.documentElement).getPropertyValue('--single').trim(), width:3},
       marker:{size:8, color:getComputedStyle(document.documentElement).getPropertyValue('--single').trim()},
       text: sr.map(v=>String(Math.round(v))), textposition:"top center", textfont:{size:12, color:"#e5e7eb"},
       hovertemplate:"%{x}<br>Single: <b>%{y}</b><extra></extra>"}
    ];
  }

  
  if(view==="totalrev"){
    addToggle("t_totalrev","Total revenue", true);
    addToggle("t_rev","Sub revenue", false);
    addToggle("t_single","Single revenue", false);

    const total = aggDesc.map(x=>x.subRevenue + x.singleRevenue);
    const rev = aggDesc.map(x=>x.subRevenue);
    const sr  = aggDesc.map(x=>x.singleRevenue);

    traces = [
      {name:"Total revenue", x, y:total, type:"scatter", mode:"lines+markers+text",
       line:{color:"#f97316", width:3},
       marker:{size:8, color:"#f97316"},
       text: total.map(v=>String(Math.round(v))), textposition:"top center", textfont:{size:12, color:"#e5e7eb", family:"system-ui",},
       hovertemplate:"%{x}<br>Total: <b>%{y}</b><extra></extra>"},
      {name:"Sub revenue", x, y:rev, type:"scatter", mode:"lines+markers",
       line:{color:getComputedStyle(document.documentElement).getPropertyValue('--rev').trim(), width:2, dash:"dot"},
       marker:{size:7, color:getComputedStyle(document.documentElement).getPropertyValue('--rev').trim()},
       hovertemplate:"%{x}<br>Sub: <b>%{y}</b><extra></extra>", visible:false},
      {name:"Single revenue", x, y:sr, type:"scatter", mode:"lines+markers",
       line:{color:getComputedStyle(document.documentElement).getPropertyValue('--single').trim(), width:2, dash:"dot"},
       marker:{size:7, color:getComputedStyle(document.documentElement).getPropertyValue('--single').trim()},
       hovertemplate:"%{x}<br>Single: <b>%{y}</b><extra></extra>", visible:false},
    ];
    layout.yaxis.title="";
  }

if(view==="arpu"){
    addToggle("t_arpu","ARPU｜每人平均", true);
    const arpu = aggDesc.map(x=>x.arpu);
    traces = [
      {name:"ARPU", x, y:arpu, type:"scatter", mode:"lines+markers+text",
       line:{color:getComputedStyle(document.documentElement).getPropertyValue('--arpu').trim(), width:3},
       marker:{size:8, color:getComputedStyle(document.documentElement).getPropertyValue('--arpu').trim()},
       text: arpu.map(v=>String(Math.round(v))), textposition:"top center", textfont:{size:12, color:"#e5e7eb"},
       hovertemplate:"%{x}<br>ARPU: <b>%{y:.2f}</b><extra></extra>"}
    ];
  }

  if(view==="money"){
    addToggle("t_rev","Sub revenue｜訂閱", true);
    addToggle("t_single","Single revenue｜單片", true);
    addToggle("t_arpu","ARPU", false);
    addToggle("t_totalrev","Total revenue｜總營收", false);

    const rev = aggDesc.map(x=>x.subRevenue);
    const total = aggDesc.map(x=>x.subRevenue + x.singleRevenue);
    const sr  = aggDesc.map(x=>x.singleRevenue);
    const arpu= aggDesc.map(x=>x.arpu);

    traces = [
      {name:"Sub revenue", x, y:rev, type:"scatter", mode:"lines+markers",
       line:{color:getComputedStyle(document.documentElement).getPropertyValue('--rev').trim(), width:3},
       marker:{size:8, color:getComputedStyle(document.documentElement).getPropertyValue('--rev').trim()},
       hovertemplate:"%{x}<br>Sub revenue: <b>%{y}</b><extra></extra>"},
      {name:"Single revenue", x, y:sr, type:"scatter", mode:"lines+markers",
       line:{color:getComputedStyle(document.documentElement).getPropertyValue('--single').trim(), width:3, dash:"dot"},
       marker:{size:8, color:getComputedStyle(document.documentElement).getPropertyValue('--single').trim()},
       hovertemplate:"%{x}<br>Single revenue: <b>%{y}</b><extra></extra>"},
      {name:"ARPU", x, y:arpu, type:"scatter", mode:"lines+markers",
       line:{color:getComputedStyle(document.documentElement).getPropertyValue('--arpu').trim(), width:3},
       marker:{size:8, color:getComputedStyle(document.documentElement).getPropertyValue('--arpu').trim()},
       hovertemplate:"%{x}<br>ARPU: <b>%{y:.2f}</b><extra></extra>", visible:false, yaxis:"y2"},
      {name:"Total revenue", x, y:total, type:"scatter", mode:"lines+markers",
       line:{color:"#f97316", width:3},
       marker:{size:8, color:"#f97316"},
       hovertemplate:"%{x}<br>Total: <b>%{y}</b><extra></extra>", visible:false}
    ];
    layout.yaxis.title = "";
    layout.yaxis2 = {
      overlaying:"y",
      side:"right",
      showgrid:false,
      tickfont:{color:"#cbd5e1"},
    };
  }

  Plotly.newPlot("chart", traces, layout, {displayModeBar:false, responsive:true});

  // Hook toggles
  toggles.querySelectorAll("input[type=checkbox]").forEach((chk)=>{
    chk.addEventListener("change", ()=>{
      const nameMap = {
        "t_new":"New users",
        "t_old":"Old users",
        "t_total":"Total",
        "t_1m":"1M",
        "t_3m":"3M",
        "t_6m":"6M",
        "t_rev":"Revenue",
        "t_single":"Single purchase revenue",
        "t_arpu":"ARPU",
        "t_totalrev":"Total revenue",
      };

      // In money overlay, labels differ a bit:
      const altMap = {
        "t_rev":"Sub revenue",
        "t_single":"Single revenue",
        "t_arpu":"ARPU",
        "t_totalrev":"Total revenue",
      };

      const label = (view==="money") ? altMap[chk.id] : nameMap[chk.id];
      const idx = traces.findIndex(t=>t.name===label);
      if(idx>=0){
        const vis = chk.checked ? true : "legendonly";
        Plotly.restyle("chart", {visible: vis}, [idx]);
      }
    });
  });
}

function renderMonthlyTable(aggDesc){
  // Newest -> Oldest
  const header = `
    <tr>
      <th>月份</th>
      <th class="right">訂閱人數</th>
      <th class="right">新客</th>
      <th class="right">舊客</th>
      <th class="right">訂閱營收</th>
      <th class="right">單片營收</th>
      <th class="right">總營收</th>
      <th class="right">ARPU</th>
    </tr>`;
  const rows = aggDesc.map(x=>{
    const arpu = x.arpu ? Math.round(x.arpu) : 0;
    return `<tr>
      <td>${x.month}</td>
      <td class="right">${x.subscribers}</td>
      <td class="right">${x.newUsers}</td>
      <td class="right">${x.oldUsers}</td>
      <td class="right">${Math.round(x.subRevenue)}</td>
      <td class="right">${Math.round(x.singleRevenue)}</td>
      <td class="right">${Math.round(x.subRevenue + x.singleRevenue)}</td>
      <td class="right">${arpu}</td>
    </tr>`;
  }).join("");
  el("monthlyTable").innerHTML = header + rows;
}

function renderTopSinglesTable(topSingles){
  const header = `
    <tr>
      <th>影片標題</th>
      <th class="right">金額</th>
      <th class="right">筆數</th>
    </tr>`;
  const rows = topSingles.map(x=>{
    const title = x.title.length>42 ? x.title.slice(0,42)+"…" : x.title;
    return `<tr>
      <td title="${x.title.replaceAll('"','&quot;')}">${title}</td>
      <td class="right">${Math.round(x.revenue)}</td>
      <td class="right">${x.count}</td>
    </tr>`;
  }).join("");
  el("topSinglesTable").innerHTML = header + rows;
}

function normalizeTable(header, data){
  const idx = {};
  header.forEach((h,i)=> idx[h.trim().toLowerCase()] = i);

  // create objects by expected fields
  return data.map(r=>{
    const get = (k)=> r[idx[k]] ?? "";
    return get;
  });
}

async function loadAll(){
  el("subline").textContent = "Loading…";
  if (location.protocol === "file:") {
    el("subline").textContent = "⚠️ Open via a website (not file://). Use Vercel or run a local server (python -m http.server).";
  }

  el("reloadBtn").disabled = true;
  try{
    const [subs, singles] = await Promise.all([fetchTable(SUB_CSV_URL), fetchTable(SINGLE_CSV_URL)]);

    // Map headers to lower
    const sh = subs.header.map(h=>h.trim().toLowerCase());
    const si = {};
    sh.forEach((h,i)=>si[h]=i);
    const subsRows = subs.data.map(r=>({
      time: r[si["time"]] ?? r[0],
      plan: r[si["plan"]] ?? r[1],
      user_id: r[si["user_id"]] ?? r[2],
      price: r[si["price"]] ?? r[3],
      fee: r[si["fee"]] ?? r[4],
    }));

    const hh = singles.header.map(h=>h.trim().toLowerCase());
    const hi = {};
    hh.forEach((h,i)=>hi[h]=i);
    const singleRows = singles.data.map(r=>({
      time: r[hi["time"]] ?? r[0],
      title: r[hi["title"]] ?? r[1],
      url: r[hi["url"]] ?? r[2],
      user_id: r[hi["user_id"]] ?? r[3],
      price: r[hi["price"]] ?? r[4],
      fee: r[hi["fee"]] ?? r[5],
    }));

    const {monthsDesc, aggDesc, topSingles} = buildMonthly(subsRows, singleRows);

    // header line
    const badge = monthsDesc.length ? `${monthsDesc[0]} → ${monthsDesc[monthsDesc.length-1]}` : "—";
    el("rangeBadge").textContent = badge;
    el("subline").textContent = `Auto-updates from Google Sheets CSV｜自動讀取試算表 · Order: newest → oldest｜新→舊 · Months: ${monthsDesc.length}`;

    // tables
    renderMonthlyTable(aggDesc);
    renderTopSinglesTable(topSingles);

    // plot initial
    const view = el("viewSelect").value;
    plotView(view, aggDesc);

    // view switch
    el("viewSelect").onchange = ()=> plotView(el("viewSelect").value, aggDesc);

  } catch(err){
    console.error(err);
    el("subline").textContent = "❌ Load failed: " + (err && err.message ? err.message : String(err)) + " · If you opened this as file://, CORS will block Google CSV. Open via Vercel / localhost server.";

    el("rangeBadge").textContent = "error";
  } finally {
    el("reloadBtn").disabled = false;
  }
}

el("reloadBtn").onclick = loadAll;
loadAll();
</script>
</body>
</html>
