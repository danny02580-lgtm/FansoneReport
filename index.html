<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Fansone Report</title>
<script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
<style>
  :root{
    --bg0:#0b1220; --bg1:#0f1a2e; --panel:rgba(255,255,255,.06); --stroke:rgba(255,255,255,.14);
    --text:#e5e7eb; --muted:#9ca3af;
    --new:#3498db; --old:#2980b9;
    --rev:#e74c3c; --single:#a78bfa; --totalrev:#f59e0b;
    --arpu:#d35400;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
    color:var(--text);
    background:
      radial-gradient(1200px 600px at 20% 10%, rgba(52,152,219,.18), transparent 60%),
      radial-gradient(900px 500px at 85% 25%, rgba(231,76,60,.16), transparent 60%),
      radial-gradient(800px 500px at 60% 90%, rgba(245,158,11,.14), transparent 60%),
      linear-gradient(180deg, var(--bg0), var(--bg1));
    min-height:100vh;
  }
  a{color:inherit; text-decoration:none}
  .wrap{max-width:1200px; margin:0 auto; padding:20px 16px 36px}
  .topbar{
    display:flex; align-items:flex-start; justify-content:space-between; gap:14px;
    padding:14px; border:1px solid var(--stroke); border-radius:16px; background:var(--panel); backdrop-filter: blur(10px);
  }
  .title h1{margin:0; font-size:18px}
  .title .sub{margin-top:6px; font-size:12px; color:var(--muted); line-height:1.4}
  #status.ok{color:#34d399}
  #status.err{color:#fb7185}
  .kpis{display:flex; flex-wrap:wrap; gap:10px; justify-content:flex-end; align-items:stretch}
  .kpi{
    padding:12px 14px; border:1px solid var(--stroke); border-radius:16px; background:rgba(255,255,255,.04);
    min-width:220px; display:flex; flex-direction:column; gap:6px;
  }
  .kpi .klabel{font-size:12px; color:var(--muted)}
  .kpi .kvalue{font-size:24px; font-weight:850; letter-spacing:.2px; color:var(--text)}
  .kpi.small{min-width:140px}
  .kpi.small .kvalue{font-size:24px}

  .grid{display:grid; grid-template-columns: 360px 1fr; gap:14px; margin-top:14px}
  @media (max-width: 980px){ .grid{grid-template-columns: 1fr} }
  .panel{border:1px solid var(--stroke); border-radius:16px; background:var(--panel); backdrop-filter: blur(10px); overflow:hidden}
  .hd{padding:12px; border-bottom:1px solid rgba(255,255,255,.10); display:flex; align-items:center; justify-content:space-between; gap:10px}
  .hd h2{margin:0; font-size:13px}
  .bd{padding:12px}

  .select{
    width:100%;
    padding:12px 12px;
    border:1px solid var(--stroke);
    border-radius:14px;
    background:rgba(255,255,255,.04);
    color:var(--text);
    font-size:13px;
    outline:none;
  }
  .hint{margin-top:8px; font-size:11px; color:var(--muted); line-height:1.45}

  .checks{display:grid; grid-template-columns: 1fr; gap:8px; margin-top:10px}
  .check{
    display:flex; gap:10px; align-items:center;
    padding:10px 10px;
    border:1px solid var(--stroke);
    border-radius:14px;
    background:rgba(255,255,255,.03);
  }
  .check input{width:18px; height:18px; accent-color: var(--new)}
  .dot{width:10px; height:10px; border-radius:999px; background:#fff; box-shadow:0 0 0 3px rgba(255,255,255,.07)}
  .label{display:flex; flex-direction:column; gap:2px}
  .label b{font-size:12px; font-weight:750}
  .label span{font-size:11px; color:var(--muted)}

  #chart{width:100%; height:560px}
  @media (max-width: 980px){ #chart{height:520px} }

  .tablesGrid{display:grid; grid-template-columns: 1.3fr 1fr; gap:14px; margin-top:14px}
  @media (max-width: 980px){ .tablesGrid{grid-template-columns: 1fr} }
  table{width:100%; border-collapse:separate; border-spacing:0; font-size:12px}
  th,td{padding:10px 10px; border-bottom:1px solid rgba(255,255,255,.08)}
  th{text-align:left; color:var(--muted); font-weight:700; background:rgba(255,255,255,.03); position:sticky; top:0; backdrop-filter: blur(10px)}
  td.right, th.right{text-align:right}
  tr:hover td{background:rgba(255,255,255,.03)}
  .sheetlink{color: var(--muted); border:1px solid var(--stroke); padding:7px 9px; border-radius:999px; background:rgba(255,255,255,.04)}
  .sheetlink:hover{color:var(--text)}
  .pill{padding:5px 8px; border:1px solid var(--stroke); border-radius:999px; font-size:11px; color:var(--muted); background:rgba(255,255,255,.03)}

/* --- Mobile polish (no layout break) --- */
@media (max-width: 860px){
  .wrap{padding:12px;}
  .hd{flex-direction:column; align-items:flex-start; gap:10px;}
  .kpis{grid-template-columns:1fr 1fr; gap:10px;}
  .kpi .big{font-size:22px;}
  .kpi .sub{font-size:12px;}
  .content{grid-template-columns:1fr; gap:12px;}
  #chart{height:360px !important;}
  .panel{border-radius:14px;}
  .controls{position:sticky; top:0; z-index:5;}
  .checks{max-height:none;}
  table{font-size:12px;}
  .tableWrap{overflow:auto; -webkit-overflow-scrolling:touch;}
}
@media (max-width: 480px){
  .kpis{grid-template-columns:1fr; }
  #chart{height:320px !important;}
  .btn, select, input[type="checkbox"]{touch-action:manipulation;}
}


/* === KPI premium cards (A) === */
.kpis{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px;margin:12px 0 14px;}
.kpi{background:linear-gradient(135deg,rgba(255,255,255,.08),rgba(255,255,255,.03));border:1px solid rgba(255,255,255,.14);
     border-radius:16px;padding:14px 14px;box-shadow:0 14px 34px rgba(0,0,0,.22);}
.kpi .klabel{font-size:12px;color:rgba(255,255,255,.70);letter-spacing:.12em;}
.kpi .kvalue{margin-top:6px;font-size:32px;font-weight:850;letter-spacing:.02em;}
@media(max-width:520px){.kpis{grid-template-columns:1fr;}.kpi .kvalue{font-size:28px;}}


/* === Segmented control (B) === */
.segmented{display:flex;gap:6px;padding:6px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.14);border-radius:14px;
           overflow-x:auto;-webkit-overflow-scrolling:touch;margin:10px 0 10px;}
.segmented::-webkit-scrollbar{height:0}
.seg-btn{flex:1 0 auto;padding:10px 12px;border-radius:12px;border:0;background:transparent;color:rgba(255,255,255,.72);font-weight:750;cursor:pointer;white-space:nowrap;}
.seg-btn.active{background:rgba(255,255,255,.12);color:rgba(255,255,255,.96);}
.select.hidden{display:none!important;}


/* --- Requested UX patches (v3_8 based) --- */
#orderTag{display:none !important;}
.twoline{display:inline-block; line-height:1.05; text-align:center;}
@media (max-width:720px){
  .twoline{font-size:12px;}
}
.kprev{margin-top:6px; font-size:12px; opacity:.85;}


/* Map user insights buttons to segmented style without triggering chart view handlers */
.userseg .userseg-btn{ all:unset; cursor:pointer; padding:10px 12px; border-radius:999px; font-weight:600; letter-spacing:.2px; }
.userseg .userseg-btn.active{ background:rgba(255,255,255,.12); box-shadow:inset 0 0 0 1px rgba(255,255,255,.14); }


/* Hide legacy Prev label */
#prevTotalRevenue{display:none !important;}


/* Match Latest KPI typography to Total Revenue */
.kpi-card[data-kpi="latest"] .kpi-title,
#kpiLatest .kpi-title, #latestKpi .kpi-title, #kpiLatestTitle, #latestKpiTitle{
  font-size: inherit;
}
.kpi-card[data-kpi="latest"] .kpi-value,
#kpiLatest .kpi-value, #latestKpi .kpi-value, #kpiLatestValue, #latestKpiValue{
  font-size: inherit;
  font-weight: inherit;
}


/* Monthly table header: single line + alignment */
#monthlyTable thead th{white-space:nowrap !important; vertical-align:middle !important;}
#monthlyTable thead th:first-child, #monthlyTable tbody td:first-child{white-space:nowrap !important; text-align:left !important;}
#monthlyTable thead th.right, #monthlyTable tbody td.right{text-align:right !important;}

</style>

<style id="hoverCardStyle">
/* Rounder, softer Plotly hover card */
.js-plotly-plot .hoverlayer .hovertext rect { rx: 12px; ry: 12px; }
.js-plotly-plot .hoverlayer .hovertext path { opacity: 0.0; } /* hide pointer notch for cleaner card */
.js-plotly-plot .hoverlayer .hovertext { filter: drop-shadow(0 8px 18px rgba(0,0,0,0.35)); }
</style>


<style id="gridSafety">
/* Safety: ensure no vertical gridlines */
.js-plotly-plot .gridlayer .xgrid { opacity: 0; }
</style>


<style id="hoverCardRoundStrong">
/* Force rounded hover card */
.js-plotly-plot .hoverlayer .hovertext rect{
  rx:14px !important;
  ry:14px !important;
}
.js-plotly-plot .hoverlayer .hovertext path{ opacity:0 !important; }
</style>


<style id="customHoverStyle">
/* Hide Plotly default hover boxes */
.js-plotly-plot .hoverlayer { display:none !important; }

/* Custom tooltip card */
#customTooltip{
  position:fixed;
  z-index:9999;
  pointer-events:none;
  min-width: 220px;
  max-width: 320px;
  padding: 12px 14px;
  border-radius: 16px;
  background: rgba(20, 24, 34, 0.78);
  border: 1px solid rgba(255,255,255,0.10);
  box-shadow: 0 14px 40px rgba(0,0,0,0.45);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  color: #fff;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans", "PingFang TC", "Microsoft JhengHei", sans-serif;
}
#customTooltip .tt-title{
  font-weight: 800;
  letter-spacing: .3px;
  margin-bottom: 8px;
  opacity: .95;
}
#customTooltip .tt-row{
  display:flex;
  align-items:center;
  gap:10px;
  margin: 7px 0;
}
#customTooltip .tt-dot{
  width:10px;height:10px;border-radius:999px;flex:0 0 10px;
}
#customTooltip .tt-name{
  flex:1;
  opacity:.92;
  font-weight:600;
}
#customTooltip .tt-val{
  font-weight:800;
  letter-spacing:.2px;
}
#customTooltip .muted{ opacity:.75; font-weight:600; }
</style>

</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div class="title">
      <h1>Fansone Report</h1>
      <div class="sub" id="status">Loading…</div>
    </div>
    <div class="kpis">
      <div class="kpi small">
        <div class="klabel">Latest</div>
        <div class="kvalue" id="months">–</div>
      </div>
      <div class="kpi">
        <div class="klabel">Total revenue</div>
        <div class="kvalue" id="totalRevenue">–</div></div>
    </div>
  </div>

  <div class="grid">
    <div class="panel">
      <div class="hd"><h2>圖表切換</h2><span class="pill" id="orderTag">新 → 舊</span></div>
      <div class="bd">
        
<div class="segmented" role="tablist" aria-label="Chart views">
  <button class="seg-btn active" type="button" data-value="money">Revenue</button>
  <button class="seg-btn" type="button" data-value="subs">Subscribers</button>
  <button class="seg-btn" type="button" data-value="mix">Plans</button>
  <button class="seg-btn" type="button" data-value="arpu">ARPU</button>
</div>

<select id="viewSelect" class="select hidden">
          <option value="money">金額（總/訂閱/單片）</option>
          <option value="subs">訂閱人數（新/舊柱狀）</option>
          <option value="mix">方案比例（1/3/6M 勾選）</option>
          <option value="arpu">ARPU（折線）</option>
        </select>
<div class="checks" id="checks"></div>
      </div>
    </div>

    <div class="panel" style="padding:10px">
      <div id="chart"></div>
    </div>
  </div>

  <div class="tablesGrid">
    <div class="panel">
      <div class="hd">
        <div style="display:flex; align-items:center; gap:10px;">
          <h2 style="margin:0;">月度總表</h2><span class="pill">訂閱 + 單片合計</span>
        </div>
      </div>
      <div class="bd" style="padding:0 0 10px 0;">
        <div style="max-height:340px; overflow:auto;">
          <table id="monthlyTable">
            <thead>
              <tr>
                <th>月份</th>
                <th class="right">訂閱人數</th>
                <th class="right">新客</th>
                <th class="right">舊客</th>
                <th class="right">訂閱營收</th>
                <th class="right">單片營收</th>
                <th class="right">總營收</th>
                <th class="right">ARPU</th>
              </tr>
            </thead>
            <tbody id="tbodyMonthly"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="panel">
      <div class="hd">
        <div style="display:flex; align-items:center; gap:10px;">
          <h2 style="margin:0;">用戶分析</h2><span class="pill">Top 10</span>
        </div>
        <div class="segmented userseg" role="tablist" aria-label="User insights metric">
  <button class="userseg-btn active" type="button" data-metric="spend_total">付最多錢</button>
  <button class="userseg-btn" type="button" data-metric="active_months">訂閱最久</button>
</div>
<select id="userMetric" style="display:none" class="select" style="max-width:220px; padding:8px 10px;">
<option value="spend_total">付最多錢（總）</option>
<option value="active_months">訂閱最久（活躍月數）</option>

          
          
          
          
          
          
        </select>
      </div>
      <div class="bd" style="padding:0 0 10px 0;">
        <div style="max-height:340px; overflow:auto;">
          <table>
            <thead>
              <tr>
                <th>User ID</th>
                <th class="right">指標</th>
                <th class="right">訂閱$</th>
                <th class="right">單片$</th>
                <th class="right">總$</th>
              </tr>
            </thead>
            <tbody id="tbodyUsers"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div class="tablesGrid" style="grid-template-columns: 1fr; margin-top:14px;">
    <div class="panel">
      <div class="hd">
        <div style="display:flex; align-items:center; gap:10px;">
          <h2 style="margin:0;">單片 TOP10</h2><span class="pill">點標題可直達貼文</span>
        </div>
</div>
      <div class="bd" style="padding:0 0 10px 0;">
        <div style="max-height:320px; overflow:auto;">
          <table>
            <thead>
              <tr>
                <th>影片標題</th>
                <th class="right">金額</th>
                <th class="right">筆數</th>
              </tr>
            </thead>
            <tbody id="tbodySingles"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>




<script id="customHoverScript">
(function(){
  function ensureTooltip(){
    let tt = document.getElementById('customTooltip');
    if(!tt){
      tt = document.createElement('div');
      tt.id = 'customTooltip';
      tt.style.display = 'none';
      document.body.appendChild(tt);
    }
    return tt;
  }

  function fmt(v, kind){
    if(v==null || isNaN(v)) return '-';
    const n = Number(v);
    if(kind==='money') return 'NT$ ' + n.toLocaleString(undefined,{maximumFractionDigits:0});
    if(kind==='pct') return n.toFixed(1) + '%';
    if(kind==='int') return n.toLocaleString(undefined,{maximumFractionDigits:0});
    return n.toLocaleString(undefined,{maximumFractionDigits:1});
  }
  function kindFor(name){
    const s=(name||'').toLowerCase();
    if(s.includes('revenue')||s.includes('營收')||s.includes('total')) return 'money';
    if(s.includes('arpu')) return 'num';
    if(s.includes('%')||s.includes('rate')||s.includes('ratio')||s.includes('比例')||s.includes('成長')) return 'pct';
    if(s.includes('user')||s.includes('subscriber')||s.includes('客')||s.includes('人數')) return 'int';
    return 'num';
  }
  function colorFor(pt){
    try{
      const tr = pt.data || pt.fullData || {};
      const c = (tr.line && tr.line.color) || (tr.marker && tr.marker.color);
      if(Array.isArray(c)) return c[0] || '#fff';
      return c || '#fff';
    }catch(e){ return '#fff'; }
  }

  function render(tt, points){
    if(!points || !points.length) return;
    const x = points[0].x;
    const title = String(x);
    const rows = points.map(pt=>{
      const name = (pt.fullData && pt.fullData.name) || (pt.data && pt.data.name) || 'Value';
      const kind = kindFor(name);
      const val = fmt(pt.y, kind);
      const dot = colorFor(pt);
      return {name, val, dot};
    });

    tt.innerHTML = `
      <div class="tt-title">${title}</div>
      ${rows.map(r=>`
        <div class="tt-row">
          <span class="tt-dot" style="background:${r.dot}"></span>
          <span class="tt-name">${r.name}</span>
          <span class="tt-val">${r.val}</span>
        </div>
      `).join('')}
    `;
  }

  function place(tt, gd, evt, pt){
    const pad = 14;
    tt.style.display = 'block';

    // Default near mouse, but fallback to point pixel position if no event
    let x = 0, y = 0;
    const hasMouse = evt && typeof evt.clientX === 'number' && typeof evt.clientY === 'number';
    if(hasMouse){
      x = evt.clientX + 18;
      y = evt.clientY + 18;
    } else if(pt && pt.xaxis && pt.yaxis && typeof pt.xaxis.l2p === 'function' && typeof pt.yaxis.l2p === 'function'){
      const bb = gd.getBoundingClientRect();
      x = bb.left + (pt.xaxis._offset || 0) + pt.xaxis.l2p(pt.x) + 18;
      y = bb.top  + (pt.yaxis._offset || 0) + pt.yaxis.l2p(pt.y) + 18;
    } else {
      const bb = gd.getBoundingClientRect();
      x = bb.left + bb.width*0.6;
      y = bb.top + bb.height*0.25;
    }

    // measure & keep in viewport
    const r = tt.getBoundingClientRect();
    const vw = window.innerWidth, vh = window.innerHeight;

    if(x + r.width + pad > vw) x = x - r.width - 36;
    if(y + r.height + pad > vh) y = y - r.height - 36;

    tt.style.left = Math.max(8, x) + 'px';
    tt.style.top  = Math.max(8, y) + 'px';
  }

  function bindOne(gd){
    if(!gd || gd.__customTTBound) return;
    if(!gd.on) return; // not a plotly gd yet
    gd.__customTTBound = true;

    const tt = ensureTooltip();

    gd.on('plotly_hover', function(e){
      try{
        const pts = (e && e.points) ? e.points : [];
        if(!pts.length) return;
        render(tt, pts);
        place(tt, gd, e.event, pts[0]);
      }catch(err){}
    });

    gd.on('plotly_unhover', function(){
      try{ tt.style.display = 'none'; }catch(e){}
    });

    gd.on('plotly_afterplot', function(){
      // keep hidden unless user hovers
      try{ tt.style.display = 'none'; }catch(e){}
    });
  }

  function scanAndBind(){
    document.querySelectorAll('.js-plotly-plot').forEach(bindOne);
  }

  // MutationObserver: data loads async so plots may appear later
  const obs = new MutationObserver(()=>scanAndBind());
  obs.observe(document.documentElement, {childList:true, subtree:true});

  window.addEventListener('load', ()=>{
    setTimeout(scanAndBind, 200);
    setTimeout(scanAndBind, 800);
    setTimeout(scanAndBind, 1500);
  });
})();
</script>

</body>
</html>
