<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>FansOne Report</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- Data labels (numbers always visible) -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

  <style>
    :root{
      --bg0:#0f1420;
      --bg1:#151b2b;
      --card:#141a2a;
      --card2:#101626;
      --stroke:rgba(255,255,255,.10);
      --text:rgba(255,255,255,.90);
      --muted:rgba(255,255,255,.65);
      --muted2:rgba(255,255,255,.45);

      --new:#3498db;        /* New users */
      --old:#2980b9;        /* Old users */
      --rev:#e74c3c;        /* Revenue */
      --arpu:#d35400;       /* ARPU */
      --single:#9b59b6;     /* Single purchase */
      --total:#2ecc71;      /* Total revenue */
      --m1:#f1c40f;         /* Plan 1 */
      --m3:#f39c12;         /* Plan 3 */
      --m6:#e67e22;         /* Plan 6 */
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", Arial, sans-serif;
      color:var(--text);
      background: radial-gradient(1200px 500px at 20% -10%, rgba(52,152,219,.20), transparent 60%),
                  radial-gradient(1000px 450px at 90% 0%, rgba(231,76,60,.18), transparent 55%),
                  linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    .container{
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px;
    }

    .top{
      display:flex;
      gap:12px;
      align-items:stretch;
      flex-wrap:wrap;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--stroke);
      border-radius:16px;
      padding:14px 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.22);
      backdrop-filter: blur(6px);
      min-width: 240px;
      flex:1;
    }

    .kpiRow{
      display:flex;
      align-items:baseline;
      gap:10px;
      flex-wrap:wrap;
    }

    .kpiTitle{
      font-size:12px;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:var(--muted);
      margin-bottom:6px;
    }

    .kpiValue{
      font-size:40px;
      font-weight:800;
      line-height:1;
      margin:0;
      white-space:nowrap;
    }

    .kpiSub{
      color:var(--muted);
      font-size:14px;
      white-space:nowrap;
    }

    .controls{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      margin-top:12px;
    }

    select{
      appearance:none;
      -webkit-appearance:none;
      -moz-appearance:none;
      background: rgba(255,255,255,.06);
      border:1px solid var(--stroke);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      font-size:14px;
      outline:none;
      min-width: 220px;
    }

    .chips{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .chip{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      color:var(--muted);
      font-size:13px;
      user-select:none;
    }
    .chip input{ accent-color: #ffffff; }

    .grid{
      display:grid;
      grid-template-columns: 1.4fr .6fr;
      gap:12px;
      margin-top:12px;
    }

    .chartCard{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--stroke);
      border-radius:16px;
      padding:12px;
      box-shadow: 0 10px 30px rgba(0,0,0,.22);
      backdrop-filter: blur(6px);
      min-height: 420px;
      position:relative;
      overflow:hidden;
    }
    .chartWrap{
      height: 380px;  /* fixed, no scrolling */
      position:relative;
    }
    canvas{ max-width:100%; }

    .sideCard{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--stroke);
      border-radius:16px;
      padding:12px;
      box-shadow: 0 10px 30px rgba(0,0,0,.22);
      backdrop-filter: blur(6px);
      min-height: 420px;
      overflow:hidden;
    }

    .sideTitle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .sideTitle h3{
      margin:0;
      font-size:14px;
      color:var(--text);
      font-weight:700;
    }
    .sideTitle a{
      color:var(--muted);
      text-decoration:none;
      font-size:12px;
      border-bottom:1px dashed rgba(255,255,255,.25);
    }
    .sideTitle a:hover{ color:var(--text); }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    th,td{
      padding:8px 6px;
      border-bottom:1px solid var(--stroke);
      text-align:left;
      color:var(--muted);
    }
    th{ color:var(--text); font-weight:700; font-size:12px; letter-spacing:.06em; text-transform:uppercase; }
    tr:last-child td{ border-bottom:none; }
    .mono{ font-variant-numeric: tabular-nums; font-feature-settings: "tnum" 1; }
    .right{ text-align:right; }
    .pill{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid var(--stroke);
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }

    .footerRow{
      margin-top:12px;
      display:flex;
      gap:12px;
      flex-wrap:wrap;
    }
    .smallCard{
      flex:1;
      min-width: 260px;
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--stroke);
      border-radius:16px;
      padding:12px;
      box-shadow: 0 10px 30px rgba(0,0,0,.22);
      backdrop-filter: blur(6px);
    }
    .smallCard h4{
      margin:0 0 8px 0;
      font-size:13px;
      color:var(--text);
      font-weight:700;
    }
    .smallCard p{
      margin:0;
      color:var(--muted);
      font-size:13px;
      line-height:1.4;
    }

    /* Mobile */
    @media (max-width: 860px){
      .grid{ grid-template-columns: 1fr; }
      .chartCard,.sideCard{ min-height: unset; }
      .chartWrap{ height: 320px; }
      .kpiValue{ font-size:32px; }
      select{ min-width: 100%; }
      .card{ min-width: 0; }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="top">
      <div class="card">
        <div class="kpiTitle">Total revenue</div>
        <div class="kpiRow">
          <div class="kpiValue mono" id="kpiTotalRevenue">$â€”</div>
          <div class="kpiSub mono" id="kpiMonths">Months â€”</div>
        </div>
        <div class="kpiSub" style="margin-top:8px;">
          <span class="pill">è¨‚é–±</span> + <span class="pill">å–®ç‰‡</span>ï¼ˆé‡‘é¡æ¬„ä½ï¼šè¨‚æœˆç‡Ÿæ”¶å°±æ˜¯ç¸½ç‡Ÿæ”¶ï¼‰
        </div>
      </div>

      <div class="card">
        <div class="kpiTitle">Data sources</div>
        <div class="kpiSub" style="line-height:1.6">
          <div>è¨‚é–±å½™ç¸½ CSVï¼š<span class="mono" id="srcSubShort">â€”</span></div>
          <div style="margin-top:6px;">å–®ç‰‡å½™ç¸½ CSVï¼š<span class="mono" id="srcSingleShort">â€”</span></div>
        </div>
      </div>
    </div>

    <div class="controls">
      <select id="viewSelect" aria-label="view selector">
        <option value="money">é‡‘é¡ï¼ˆè¨‚é–± / å–®ç‰‡ / ç¸½ç‡Ÿæ”¶ï¼‰</option>
        <option value="subs">è¨‚é–±äººæ•¸ï¼ˆæ–°å®¢ / èˆŠå®¢ï¼‰</option>
        <option value="plans">æ–¹æ¡ˆæ¯”ä¾‹ï¼ˆ1 / 3 / 6 å€‹æœˆï¼‰</option>
        <option value="arpu">ARPUï¼ˆæ¯äººå¹³å‡ç‡Ÿæ”¶ï¼‰</option>
        <option value="users">ç”¨æˆ¶åˆ†æï¼ˆTopï¼‰</option>
      </select>

      <div class="chips" id="chipsArea">
        <!-- dynamic -->
      </div>
    </div>

    <div class="grid">
      <div class="chartCard">
        <div class="chartWrap">
          <canvas id="chart"></canvas>
        </div>
      </div>

      <div class="sideCard" id="sideCard">
        <div class="sideTitle">
          <h3 id="sideTitle">Top users</h3>
          <a id="sideLink" href="#" target="_blank" rel="noopener">Open sheet</a>
        </div>
        <div style="overflow:auto; max-height:380px;">
          <table id="sideTable">
            <thead><tr><th>User</th><th class="right">Value</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="footerRow">
      <div class="smallCard">
        <h4>Tips</h4>
        <p>æ»‘é¼ åœåœ¨ä»»ä½•é»æœƒé¡¯ç¤ºå®Œæ•´è³‡è¨Šï¼›åŒæ™‚æˆ‘æŠŠæ•¸å­—ç›´æ¥æ¨™åœ¨åœ–ä¸Šï¼ˆä¸ç”¨ä¸€å€‹ä¸€å€‹é» ğŸ˜Œï¼‰ã€‚æ‰‹æ©Ÿç‰ˆå·²åšè‡ªå‹•æ›è¡Œï¼Œåœ–è¡¨å›ºå®šé«˜åº¦ã€ä¸æ”¯æ´æ‹–æ›³/ç¸®æ”¾ã€‚</p>
      </div>
      <div class="smallCard">
        <h4>Links</h4>
        <p>
          <a id="linkSubSheet" href="#" target="_blank" rel="noopener" style="color:var(--text); text-decoration:none; border-bottom:1px dashed rgba(255,255,255,.3)">è¨‚é–±è©¦ç®—è¡¨</a>
          <span style="color:var(--muted2)"> / </span>
          <a id="linkSingleSheet" href="#" target="_blank" rel="noopener" style="color:var(--text); text-decoration:none; border-bottom:1px dashed rgba(255,255,255,.3)">å–®ç‰‡è©¦ç®—è¡¨</a>
        </p>
      </div>
    </div>
  </div>

<script>
/** =========================
 *  CONFIG (edit here only)
 *  ========================= */
const SUB_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQiAPNDCD7qn6atO4VB6Ei63AacDK00AMKM16hK8c-wVWFadPPOj-P8olYQ-ofMFwy0maGU1A4CBneW/pub?gid=0&single=true&output=csv";
const SINGLE_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQiAPNDCD7qn6atO4VB6Ei63AacDK00AMKM16hK8c-wVWFadPPOj-P8olYQ-ofMFwy0maGU1A4CBneW/pub?gid=1226262547&single=true&output=csv";

// For your sheet hyperlinks (user asked for â€œclickable title to sheetâ€)
const SUB_SHEET_LINK = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQiAPNDCD7qn6atO4VB6Ei63AacDK00AMKM16hK8c-wVWFadPPOj-P8olYQ-ofMFwy0maGU1A4CBneW/pubhtml?gid=0";
const SINGLE_SHEET_LINK = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQiAPNDCD7qn6atO4VB6Ei63AacDK00AMKM16hK8c-wVWFadPPOj-P8olYQ-ofMFwy0maGU1A4CBneW/pubhtml?gid=1226262547";

/** Colors */
const C = {
  new: getCss("--new"),
  old: getCss("--old"),
  rev: getCss("--rev"),
  arpu: getCss("--arpu"),
  single: getCss("--single"),
  total: getCss("--total"),
  m1: getCss("--m1"),
  m3: getCss("--m3"),
  m6: getCss("--m6"),
  text: getCss("--text"),
  muted: getCss("--muted"),
  grid: "rgba(255,255,255,.10)"
};

function getCss(varName){
  return getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
}

/** =========================
 *  CSV helpers
 *  ========================= */
function parseCSV(text){
  // Handles commas + quoted fields
  const rows = [];
  let row = [], cur = "", inQ = false;
  for (let i=0;i<text.length;i++){
    const ch = text[i];
    const nxt = text[i+1];
    if (ch === '"' ){
      if (inQ && nxt === '"'){ cur += '"'; i++; }
      else inQ = !inQ;
    } else if (ch === ',' && !inQ){
      row.push(cur); cur = "";
    } else if ((ch === '\n' || ch === '\r') && !inQ){
      if (ch === '\r' && nxt === '\n') i++;
      row.push(cur);
      if (row.some(v => v !== "")) rows.push(row);
      row = []; cur = "";
    } else {
      cur += ch;
    }
  }
  row.push(cur);
  if (row.some(v => v !== "")) rows.push(row);
  return rows;
}

function normalizeHeader(h){
  return (h || "")
    .trim()
    .toLowerCase()
    .replace(/\s+/g,"")
    .replace(/[%$â‚©Â¥â‚¬]/g,"")
    .replace(/[()ï¼ˆï¼‰]/g,"");
}

function toNumber(x){
  if (x == null) return 0;
  const s = String(x).replace(/[, ]/g,"").replace(/[^\d.\-]/g,"");
  const v = parseFloat(s);
  return Number.isFinite(v) ? v : 0;
}

function fmtMoney(n){
  const v = Math.round(n);
  return "$" + v.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}
function fmtNum(n){
  const v = Math.round(n);
  return v.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}
function fmtPct(n){
  if (!Number.isFinite(n)) return "0%";
  return (n*100).toFixed(1) + "%";
}

/** =========================
 *  State
 *  ========================= */
let monthly = [];   // merged monthly records
let chart = null;

const el = {
  kpiTotalRevenue: document.getElementById("kpiTotalRevenue"),
  kpiMonths: document.getElementById("kpiMonths"),
  viewSelect: document.getElementById("viewSelect"),
  chipsArea: document.getElementById("chipsArea"),
  sideTitle: document.getElementById("sideTitle"),
  sideLink: document.getElementById("sideLink"),
  sideTbody: document.querySelector("#sideTable tbody"),
  srcSubShort: document.getElementById("srcSubShort"),
  srcSingleShort: document.getElementById("srcSingleShort"),
  linkSubSheet: document.getElementById("linkSubSheet"),
  linkSingleSheet: document.getElementById("linkSingleSheet"),
};

el.linkSubSheet.href = SUB_SHEET_LINK;
el.linkSingleSheet.href = SINGLE_SHEET_LINK;

/** =========================
 *  Load + Merge
 *  ========================= */
async function fetchCSV(url){
  const r = await fetch(url, { cache: "no-store" });
  if (!r.ok) throw new Error("Fetch failed: " + r.status);
  return await r.text();
}

function shortUrl(u){
  try{
    const x = new URL(u);
    return x.host + x.pathname.slice(0, 28) + "â€¦";
  }catch(e){ return "â€”"; }
}

function monthSortKey(m){
  // supports "2025-06" or "6" or "06" or "Jun"
  const s = String(m).trim();
  const m1 = s.match(/^(\d{4})[-\/](\d{1,2})/);
  if (m1) return parseInt(m1[1])*100 + parseInt(m1[2]);
  const m2 = s.match(/^(\d{1,2})$/);
  if (m2) return 2025*100 + parseInt(m2[1]); // fallback year
  return 0;
}

function unifyMonthLabel(m){
  const s = String(m).trim();
  const m1 = s.match(/^(\d{4})[-\/](\d{1,2})/);
  if (m1) return `${m1[1]}-${String(m1[2]).padStart(2,"0")}`;
  const m2 = s.match(/^(\d{1,2})$/);
  if (m2) return `2025-${String(m2[1]).padStart(2,"0")}`;
  return s || "â€”";
}

function rowsToObjects(rows){
  if (!rows.length) return [];
  const headers = rows[0].map(normalizeHeader);
  const out = [];
  for (let i=1;i<rows.length;i++){
    const r = rows[i];
    const obj = {};
    for (let j=0;j<headers.length;j++){
      obj[headers[j] || ("c"+j)] = (r[j] ?? "").trim();
    }
    out.push(obj);
  }
  return out;
}

function guessMonthlyFields(obj){
  // We try multiple header aliases to be robust.
  const get = (...keys) => {
    for (const k of keys){
      if (obj[k] != null && obj[k] !== "") return obj[k];
    }
    return "";
  };

  const month = get("month","æœˆä»½","time_month","æ™‚é–“æœˆä»½","å¹´æœˆ","ym","æ—¥æœŸæœˆä»½","monthlabel","æœˆä»½month");
  const subscribers = toNumber(get("subscribers","è¨‚é–±äººæ•¸","è¨‚é–±æ•¸","subscriber","subs"));
  const newUsers = toNumber(get("newusers","æ–°å®¢","æ–°æˆ¶","new"));
  const oldUsers = toNumber(get("oldusers","èˆŠå®¢","èˆŠæˆ¶","old"));
  const rev = toNumber(get("revenue","è¨‚æœˆç‡Ÿæ”¶","ç‡Ÿæ”¶","rev","totalrevenue","ç¸½ç‡Ÿæ”¶"));
  const arpu = toNumber(get("arpu","æ¯äººå¹³å‡ç‡Ÿæ”¶","peruserrevenue"));

  const m1 = toNumber(get("1month","å–®æœˆ","å–®æœˆ%","å–®æœˆæ¯”ä¾‹","m1","one"));
  const m3 = toNumber(get("3month","ä¸‰æœˆ","ä¸‰å€‹æœˆ","ä¸‰æœˆ%","m3","three"));
  const m6 = toNumber(get("6month","å…­æœˆ","å…­å€‹æœˆ","å…­æœˆ%","m6","six"));

  // If plan values look like percent strings already in 0-100, normalize to 0-1.
  const normPct = (v) => v > 1 ? v/100 : v;

  return {
    month: unifyMonthLabel(month || get("æ™‚é–“","date","æ—¥æœŸ") || ""),
    monthKey: monthSortKey(month || ""),
    subscribers,
    newUsers,
    oldUsers,
    revenue: rev,
    arpu,
    plan1: normPct(m1),
    plan3: normPct(m3),
    plan6: normPct(m6),
  };
}

async function load(){
  el.srcSubShort.textContent = shortUrl(SUB_CSV_URL);
  el.srcSingleShort.textContent = shortUrl(SINGLE_CSV_URL);

  const [subTxt, singleTxt] = await Promise.all([
    fetchCSV(SUB_CSV_URL),
    fetchCSV(SINGLE_CSV_URL)
  ]);

  const subRows = parseCSV(subTxt);
  const singleRows = parseCSV(singleTxt);

  const subObjs = rowsToObjects(subRows).map(guessMonthlyFields);
  // single sheet likely has month + revenue only (weâ€™ll try same field guessing)
  const singleObjsRaw = rowsToObjects(singleRows);

  const singleObjs = singleObjsRaw.map(o => {
    const month = unifyMonthLabel(o["month"] || o["æœˆä»½"] || o["æ™‚é–“æœˆä»½"] || o["å¹´æœˆ"] || o["ym"] || o["date"] || "");
    const rev = toNumber(o["revenue"] || o["é‡‘é¡"] || o["å–®ç‰‡è³¼è²·é‡‘é¡"] || o["å–®ç‰‡è³¼è²·æ”¶å…¥"] || o["price"] || o["ç¸½é‡‘é¡"] || o["amount"]);
    return { month, monthKey: monthSortKey(month), singleRevenue: rev };
  }).filter(x => x.month && x.month !== "â€”");

  // Merge by month
  const map = new Map();
  for (const r of subObjs){
    if (!r.month || r.month === "â€”") continue;
    map.set(r.month, {...r, singleRevenue: 0});
  }
  for (const s of singleObjs){
    const base = map.get(s.month) || { month: s.month, monthKey: s.monthKey, subscribers:0,newUsers:0,oldUsers:0,revenue:0,arpu:0,plan1:0,plan3:0,plan6:0, singleRevenue:0 };
    base.singleRevenue = s.singleRevenue;
    base.monthKey = base.monthKey || s.monthKey;
    map.set(s.month, base);
  }

  monthly = Array.from(map.values()).sort((a,b) => a.monthKey - b.monthKey);

  // If ARPU not provided, compute from revenue/subscribers when possible
  for (const r of monthly){
    if (!r.arpu && r.subscribers > 0 && r.revenue > 0){
      r.arpu = r.revenue / r.subscribers;
    }
    // total revenue = subscription revenue (already "total") + single revenue
    r.totalRevenue = (r.revenue || 0) + (r.singleRevenue || 0);
    // If subscribers missing but new/old exist
    if (!r.subscribers && (r.newUsers || r.oldUsers)){
      r.subscribers = (r.newUsers || 0) + (r.oldUsers || 0);
    }
  }

  // KPI
  const totalAll = monthly.reduce((s,r)=>s+(r.totalRevenue||0),0);
  el.kpiTotalRevenue.textContent = fmtMoney(totalAll);
  el.kpiMonths.textContent = "Months " + monthly.length;

  // default links in side panel
  el.sideLink.href = SUB_SHEET_LINK;

  // Render
  Chart.register(ChartDataLabels);
  render();
}

function baseChartOptions(){
  return {
    responsive: true,
    maintainAspectRatio: false,
    animation: false,
    interaction: { mode: "nearest", intersect: false },
    plugins: {
      legend: { display:false },
      tooltip: {
        enabled: true,
        backgroundColor: "rgba(0,0,0,.75)",
        titleColor: "#fff",
        bodyColor: "#fff",
        padding: 10,
        displayColors: true,
        callbacks: {
          label: (ctx) => {
            const label = ctx.dataset.label || "";
            const v = ctx.parsed.y;
            if (label.toLowerCase().includes("pct") || label.includes("%")) return `${label}: ${fmtPct(v)}`;
            if (label.toLowerCase().includes("arpu")) return `${label}: ${fmtMoney(v)}`;
            if (label.toLowerCase().includes("revenue") || label.toLowerCase().includes("amount") || label.toLowerCase().includes("total")) return `${label}: ${fmtMoney(v)}`;
            return `${label}: ${fmtNum(v)}`;
          }
        }
      },
      datalabels: {
        color: C.text,
        font: (ctx) => ({ weight: "700", size: 11 }),
        anchor: "end",
        align: "end",
        offset: 2,
        clamp: true,
        clip: false,
        formatter: (v, ctx) => {
          const label = (ctx.dataset.label || "").toLowerCase();
          if (label.includes("pct")) return (v*100).toFixed(0) + "%";
          if (label.includes("arpu")) return Math.round(v).toString();
          if (label.includes("revenue") || label.includes("amount") || label.includes("total")) return Math.round(v).toString();
          return Math.round(v).toString();
        }
      }
    },
    scales: {
      x: {
        ticks: { color: C.muted },
        grid: { color: "rgba(255,255,255,.06)" }
      },
      y: {
        ticks: { color: C.muted },
        grid: { color: "rgba(255,255,255,.06)" }
      }
    }
  };
}

function destroyChart(){
  if (chart){ chart.destroy(); chart = null; }
}

function setChips(chips){
  // chips: [{id,label,checked,onChange}]
  el.chipsArea.innerHTML = "";
  for (const c of chips){
    const wrap = document.createElement("label");
    wrap.className = "chip";
    const input = document.createElement("input");
    input.type = "checkbox";
    input.checked = c.checked;
    input.id = c.id;
    input.addEventListener("change", () => c.onChange(input.checked));
    const span = document.createElement("span");
    span.textContent = c.label;
    wrap.appendChild(input);
    wrap.appendChild(span);
    el.chipsArea.appendChild(wrap);
  }
}

function renderMoney(){
  const labels = monthly.map(r=>r.month);
  const subRev = monthly.map(r=>r.revenue||0);
  const singleRev = monthly.map(r=>r.singleRevenue||0);
  const totalRev = monthly.map(r=>r.totalRevenue||0);

  el.sideTitle.textContent = "å–®ç‰‡è³¼è²·";
  el.sideLink.href = SINGLE_SHEET_LINK;

  // Side table: show single revenue by month
  el.sideTbody.innerHTML = "";
  monthly.slice().reverse().forEach(r=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td class="mono">${r.month}</td><td class="right mono">${fmtMoney(r.singleRevenue||0)}</td>`;
    el.sideTbody.appendChild(tr);
  });

  // Toggles
  const state = { sub:true, single:true, total:true };
  setChips([
    { id:"tSub", label:"è¨‚é–±ç‡Ÿæ”¶", checked:true, onChange:(v)=>{state.sub=v; update();} },
    { id:"tSingle", label:"å–®ç‰‡ç‡Ÿæ”¶", checked:true, onChange:(v)=>{state.single=v; update();} },
    { id:"tTotal", label:"ç¸½ç‡Ÿæ”¶", checked:true, onChange:(v)=>{state.total=v; update();} },
  ]);

  function buildDatasets(){
    const ds = [];
    if (state.sub){
      ds.push({
        label:"Subscription revenue",
        type:"line",
        data: subRev,
        borderColor: C.rev,
        backgroundColor: C.rev,
        tension:.35,
        borderWidth:2,
        pointRadius:3,
        pointHoverRadius:4,
        yAxisID:"y"
      });
    }
    if (state.single){
      ds.push({
        label:"Single purchase revenue",
        type:"line",
        data: singleRev,
        borderColor: C.single,
        backgroundColor: C.single,
        tension:.35,
        borderWidth:2,
        pointRadius:3,
        pointHoverRadius:4,
        yAxisID:"y"
      });
    }
    if (state.total){
      ds.push({
        label:"Total revenue",
        type:"bar",
        data: totalRev,
        backgroundColor: "rgba(46,204,113,.85)",
        borderColor: C.total,
        borderWidth:1,
        borderRadius: 8,
        yAxisID:"y"
      });
    }
    return ds;
  }

  destroyChart();
  const ctx = document.getElementById("chart");
  chart = new Chart(ctx, {
    data: { labels, datasets: buildDatasets() },
    options: {
      ...baseChartOptions(),
      scales: {
        x: baseChartOptions().scales.x,
        y: {
          ...baseChartOptions().scales.y,
          ticks: { ...baseChartOptions().scales.y.ticks, callback: (v)=>v }
        }
      }
    }
  });

  function update(){
    chart.data.datasets = buildDatasets();
    chart.update();
  }
}

function renderSubs(){
  const labels = monthly.map(r=>r.month);
  const newU = monthly.map(r=>r.newUsers||0);
  const oldU = monthly.map(r=>r.oldUsers||0);

  el.sideTitle.textContent = "è¨‚é–±è©¦ç®—è¡¨";
  el.sideLink.href = SUB_SHEET_LINK;

  // Side table: subscribers breakdown
  el.sideTbody.innerHTML = "";
  monthly.slice().reverse().forEach(r=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td class="mono">${r.month}</td><td class="right mono">${fmtNum(r.subscribers||0)}</td>`;
    el.sideTbody.appendChild(tr);
  });

  setChips([]); // no toggles

  destroyChart();
  const ctx = document.getElementById("chart");
  chart = new Chart(ctx, {
    type:"bar",
    data:{
      labels,
      datasets:[
        {
          label:"New users",
          data:newU,
          backgroundColor: "rgba(52,152,219,.88)",
          borderColor: C.new,
          borderWidth:1,
          borderRadius:8,
          stack:"s"
        },
        {
          label:"Old users",
          data:oldU,
          backgroundColor: "rgba(41,128,185,.88)",
          borderColor: C.old,
          borderWidth:1,
          borderRadius:8,
          stack:"s"
        }
      ]
    },
    options:{
      ...baseChartOptions(),
      scales:{
        x:{ ...baseChartOptions().scales.x, stacked:true },
        y:{ ...baseChartOptions().scales.y, stacked:true }
      },
      plugins:{
        ...baseChartOptions().plugins,
        datalabels:{
          ...baseChartOptions().plugins.datalabels,
          anchor:"center",
          align:"center",
          formatter:(v, ctx) => v ? Math.round(v).toString() : ""
        }
      }
    }
  });
}

function renderPlans(){
  const labels = monthly.map(r=>r.month);
  const p1 = monthly.map(r=>r.plan1||0);
  const p3 = monthly.map(r=>r.plan3||0);
  const p6 = monthly.map(r=>r.plan6||0);

  el.sideTitle.textContent = "æ–¹æ¡ˆæ¯”ä¾‹";
  el.sideLink.href = SUB_SHEET_LINK;

  // Side table: show plan ratios for last months
  el.sideTbody.innerHTML = "";
  monthly.slice().reverse().forEach(r=>{
    const tr = document.createElement("tr");
    const a = (r.plan1||0), b=(r.plan3||0), c=(r.plan6||0);
    tr.innerHTML = `<td class="mono">${r.month}</td><td class="right mono">${Math.round((b+c)*100)}%</td>`;
    el.sideTbody.appendChild(tr);
  });

  const state = { m1:true, m3:true, m6:true };
  setChips([
    { id:"p1", label:"1 month", checked:true, onChange:(v)=>{state.m1=v; update();} },
    { id:"p3", label:"3 months", checked:true, onChange:(v)=>{state.m3=v; update();} },
    { id:"p6", label:"6 months", checked:true, onChange:(v)=>{state.m6=v; update();} },
  ]);

  function build(){
    const ds=[];
    if (state.m1) ds.push({ label:"1m pct", data:p1, backgroundColor:"rgba(241,196,15,.85)", borderColor:C.m1, borderWidth:1, borderRadius:8, stack:"p" });
    if (state.m3) ds.push({ label:"3m pct", data:p3, backgroundColor:"rgba(243,156,18,.85)", borderColor:C.m3, borderWidth:1, borderRadius:8, stack:"p" });
    if (state.m6) ds.push({ label:"6m pct", data:p6, backgroundColor:"rgba(230,126,34,.85)", borderColor:C.m6, borderWidth:1, borderRadius:8, stack:"p" });
    return ds;
  }

  destroyChart();
  const ctx = document.getElementById("chart");
  chart = new Chart(ctx, {
    type:"bar",
    data:{ labels, datasets: build() },
    options:{
      ...baseChartOptions(),
      scales:{
        x:{ ...baseChartOptions().scales.x, stacked:true },
        y:{
          ...baseChartOptions().scales.y,
          stacked:true,
          min:0,
          max:1,
          ticks:{ ...baseChartOptions().scales.y.ticks, callback:(v)=> (v*100).toFixed(0) }
        }
      },
      plugins:{
        ...baseChartOptions().plugins,
        datalabels:{
          ...baseChartOptions().plugins.datalabels,
          formatter:(v)=> v ? (v*100).toFixed(0)+"%" : "",
          anchor:"center",
          align:"center",
          offset:0
        }
      }
    }
  });

  function update(){
    chart.data.datasets = build();
    chart.update();
  }
}

function renderARPU(){
  const labels = monthly.map(r=>r.month);
  const arpu = monthly.map(r=>r.arpu||0);

  el.sideTitle.textContent = "ARPU";
  el.sideLink.href = SUB_SHEET_LINK;

  // Side table: ARPU by month
  el.sideTbody.innerHTML = "";
  monthly.slice().reverse().forEach(r=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td class="mono">${r.month}</td><td class="right mono">${fmtMoney(r.arpu||0)}</td>`;
    el.sideTbody.appendChild(tr);
  });

  setChips([]); // no checkboxes

  destroyChart();
  const ctx = document.getElementById("chart");
  chart = new Chart(ctx, {
    type:"line",
    data:{
      labels,
      datasets:[
        {
          label:"ARPU",
          data: arpu,
          borderColor: C.arpu,
          backgroundColor: C.arpu,
          borderWidth:2,
          tension:.35,
          pointRadius:3,
          pointHoverRadius:4
        }
      ]
    },
    options:{
      ...baseChartOptions(),
      plugins:{
        ...baseChartOptions().plugins,
        datalabels:{
          ...baseChartOptions().plugins.datalabels,
          formatter:(v)=> v ? Math.round(v).toString() : "",
          font:()=>({weight:"800", size:12}),
          offset:6
        }
      }
    }
  });
}

function renderUsers(){
  // We don't have per-user data from monthly sheets, so we infer â€œTopâ€ from totals by month.
  // If you later provide a user-level CSV, we can replace this with real rankings.
  const labels = monthly.map(r=>r.month);
  const total = monthly.map(r=>r.totalRevenue||0);

  el.sideTitle.textContent = "ç”¨æˆ¶åˆ†æï¼ˆç¤ºæ„ï¼‰";
  el.sideLink.href = SUB_SHEET_LINK;
  el.sideTbody.innerHTML = `
    <tr><td colspan="2" style="color:var(--muted); line-height:1.5">
      ç›®å‰ä½ æä¾›çš„å…©å€‹ CSV æ˜¯ã€Œæœˆå½™ç¸½ã€ï¼Œæ²’æœ‰å–®ä¸€ç”¨æˆ¶å±¤ç´šè³‡æ–™ï¼Œæ‰€ä»¥é€™é å…ˆæ”¾<strong style="color:var(--text)">ç¤ºæ„</strong>ï¼š<br/>
      - å¦‚æœä½ ä¹‹å¾Œå†ä¸Ÿã€Œæ˜ç´° CSVï¼ˆæ™‚é–“ / æ–¹æ¡ˆ / userId / é‡‘é¡ï¼‰ã€æˆ‘å°±èƒ½çœŸçš„ç®— Top10ï¼šä»˜æœ€å¤šã€è²·æœ€å¤šæ¬¡ã€è¨‚é–±æœ€ä¹…â€¦<br/>
      ï¼ˆä½ ä¹‹å‰çš„ FO æ˜ç´°é‚£ç¨®å°±è¡Œï¼‰
    </td></tr>
  `;

  setChips([]);

  destroyChart();
  const ctx = document.getElementById("chart");
  chart = new Chart(ctx, {
    type:"bar",
    data:{
      labels,
      datasets:[
        {
          label:"Total revenue",
          data: total,
          backgroundColor: "rgba(46,204,113,.85)",
          borderColor: C.total,
          borderWidth:1,
          borderRadius:10
        }
      ]
    },
    options:{
      ...baseChartOptions(),
      plugins:{
        ...baseChartOptions().plugins,
        datalabels:{
          ...baseChartOptions().plugins.datalabels,
          formatter:(v)=> v ? Math.round(v).toString() : "",
          anchor:"end",
          align:"end",
          offset:4
        }
      }
    }
  });
}

function render(){
  const v = el.viewSelect.value;
  if (v === "money") renderMoney();
  else if (v === "subs") renderSubs();
  else if (v === "plans") renderPlans();
  else if (v === "arpu") renderARPU();
  else renderUsers();
}

el.viewSelect.addEventListener("change", render);

// boot
load().catch(err=>{
  console.error(err);
  document.body.innerHTML = `<div style="padding:24px; color:#fff; font-family:system-ui">
    <h2>Loading failed</h2>
    <p style="opacity:.8">Could not load CSV. Please check your Google Sheet publish settings or the URL.</p>
    <pre style="background:#000; padding:12px; border-radius:10px; overflow:auto">${String(err)}</pre>
  </div>`;
});
</script>

</body>
</html>
